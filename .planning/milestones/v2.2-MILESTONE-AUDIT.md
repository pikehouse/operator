---
milestone: v2.2
audited: 2026-01-27T20:00:00Z
status: gaps_found
scores:
  requirements: 5/11
  phases: 2/2
  integration: 8/9
  flows: 0/2
gaps:
  requirements:
    - "DEMO-01: Demo runs in EXECUTE mode — BLOCKED by ActionRegistry bug"
    - "AGENT-01: Agent executes action immediately — BLOCKED by agent crash"
    - "TIKV-02: Node kill → transfer-leader → verify — BLOCKED"
    - "TIKV-03: TiKV demo shows complete loop — BLOCKED"
    - "RLIM-02: Counter drift → reset_counter → verify — BLOCKED"
    - "RLIM-03: Rate limiter demo shows complete loop — BLOCKED"
  integration:
    - "agent.py:152 calls nonexistent ActionRegistry.from_subject()"
  flows:
    - "TiKV agentic remediation: breaks at agent subprocess initialization"
    - "Rate limiter agentic remediation: breaks at agent subprocess initialization"
tech_debt: []
---

# Milestone v2.2 Audit Report: Agentic Remediations Demo

**Audited:** 2026-01-27T20:00:00Z
**Status:** gaps_found
**Overall Score:** 5/11 requirements satisfied

## Executive Summary

Both phase verifications passed structural checks, but **integration testing reveals a critical wiring bug** that breaks all E2E flows. The agent subprocess crashes on initialization when `OPERATOR_SAFETY_MODE=execute` because `agent.py:152` calls `ActionRegistry.from_subject()`, a method that does not exist.

**Impact:** Neither TiKV nor rate limiter demos can demonstrate the agentic loop. The agent crashes before reaching the execute/verify code paths.

## Critical Finding

### ActionRegistry Instantiation Bug

**Location:** `/packages/operator-core/src/operator_core/cli/agent.py:152`

**Actual code:**
```python
registry = ActionRegistry.from_subject(subject_instance)
```

**Expected:**
```python
registry = ActionRegistry(subject_instance)
```

**Evidence:**
- `ActionRegistry.__init__(self, subject)` is the only constructor
- `ActionRegistry.from_subject()` classmethod does not exist
- Error: `AttributeError: type object 'ActionRegistry' has no attribute 'from_subject'`

**Blast radius:**
- Both TiKV and rate limiter demos fail identically
- Agent subprocess crashes immediately in EXECUTE mode
- All Phase 21 agentic loop code is unreachable
- 6 of 11 requirements blocked

## Phase Verification Summary

| Phase | Status | Plans | Notes |
|-------|--------|-------|-------|
| 21: Agent Agentic Loop | passed | 2/2 | Structural checks passed; runtime bug in CLI wiring |
| 22: Demo Integration | passed | 1/1 | Narratives correct; depends on broken Phase 21 CLI |

Both phases passed their individual verification, but the verifier checked code structure, not runtime behavior. The bug is in the glue code between phases.

## Requirements Coverage

### Satisfied (5/11)

| Requirement | Evidence |
|-------------|----------|
| AGENT-02: Agent waits 5s after action before verification | runner.py:320 `asyncio.sleep(5.0)` |
| AGENT-03: Agent queries subject metrics to verify fix | runner.py:323 `self.subject.observe()` |
| AGENT-04: Agent outputs verification result to log | runner.py:337 prints result |
| TIKV-01: TiKV chapter narratives updated for agentic flow | Stage 6 "AI Remediation" |
| RLIM-01: Rate limiter chapter narratives updated for agentic flow | Stages 5 & 9 "AI Remediation" |

### Blocked by Bug (6/11)

| Requirement | Status | Reason |
|-------------|--------|--------|
| DEMO-01: Demo runs in EXECUTE mode | BLOCKED | Agent crashes before reaching execute |
| AGENT-01: Agent executes action immediately after diagnosis | BLOCKED | Code exists but unreachable |
| TIKV-02: Node kill → transfer-leader → verify regions rebalanced | BLOCKED | Cannot execute actions |
| TIKV-03: TiKV demo shows complete loop in agent panel | BLOCKED | Agent crashes |
| RLIM-02: Counter drift → reset_counter → verify counters aligned | BLOCKED | Cannot execute actions |
| RLIM-03: Rate limiter demo shows complete loop in agent panel | BLOCKED | Agent crashes |

## E2E Flow Analysis

### Flow 1: TiKV Demo Agentic Remediation

| Step | Status | Evidence |
|------|--------|----------|
| 1. Demo starts | ✓ | TUIDemoController.run() |
| 2. Agent spawned with EXECUTE mode env vars | ✓ | tui_integration.py:160-161 |
| 3. Fault injected | ✓ | kill_random_tikv() |
| 4. Monitor detects | ✓ | MonitorLoop → subject.observe() |
| 5. Agent diagnoses | ✓ | AgentRunner._diagnose_ticket() |
| 6. Agent proposes transfer_leader | ✓ | runner.py:275 |
| 7. Agent executes | **✗ BREAKS** | agent.py:152 crashes |
| 8. Agent verifies | — | Unreachable |
| 9. Panel shows result | — | Unreachable |

**Broken at:** Step 7 — Agent subprocess initialization

### Flow 2: Rate Limiter Demo Agentic Remediation

Same pattern as TiKV. Steps 1-6 pass, step 7 crashes, steps 8-9 unreachable.

## Cross-Phase Integration

### Connected (8/9 exports)

| Phase | Export | Consumer | Status |
|-------|--------|----------|--------|
| 21-01 | AgentRunner with executor support | TUIDemoController | CONNECTED |
| 21-01 | 5s delay before verification | Demo narratives | CONNECTED |
| 21-01 | Post-action verification via observe() | runner.py | CONNECTED |
| 21-01 | Verification result logging | runner.py:337 | CONNECTED |
| 21-02 | EXECUTE mode configuration | Demo env vars | CONNECTED |
| 21-02 | Agent subprocess env vars | SubprocessManager | CONNECTED |
| 22-01 | TiKV narratives with transfer_leader | tikv.py | CONNECTED |
| 22-01 | Rate limiter narratives with reset_counter | ratelimiter.py | CONNECTED |

### Broken (1/9)

| Export | Issue |
|--------|-------|
| ActionRegistry integration | agent.py:152 calls nonexistent `from_subject()` |

## Tech Debt

None accumulated. The issue is a bug, not deferred work.

## Recommendation

**Fix Required Before Completion:**

Change `/packages/operator-core/src/operator_core/cli/agent.py:152` from:
```python
registry = ActionRegistry.from_subject(subject_instance)
```
to:
```python
registry = ActionRegistry(subject_instance)
```

After fix:
1. Re-run both demos to verify E2E flow
2. Update phase verification if needed
3. Complete milestone

---
*Audited: 2026-01-27T20:00:00Z*
*Auditor: Claude (gsd-integration-checker + orchestrator)*
