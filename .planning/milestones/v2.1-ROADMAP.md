# v2.1 Multi-Subject Support (Archived)

**Shipped:** 2026-01-27
**Phases:** 16-20 (5 phases, 21 plans)
**Theme:** Prove the operator abstraction generalizes beyond TiKV

## Milestone Goal

AI demonstrates real diagnostic reasoning about distributed systems — proving the abstraction works for novel, out-of-distribution systems. The rate limiter is a custom service with completely different semantics than TiKV, yet the same operator-core code diagnoses both.

## Key Accomplishments

1. **Protocol-based abstractions** — SubjectProtocol and InvariantCheckerProtocol in standalone operator-protocols package with zero dependencies
2. **Rate limiter service** — Custom 3-node distributed rate limiter with sliding window counters, atomic Lua scripts, and Prometheus metrics
3. **operator-ratelimiter package** — Full implementation of Subject Protocol with 5 invariant types and 2 actions
4. **Multi-subject CLI** — `--subject tikv|ratelimiter` flag for selecting which system to monitor
5. **Unified demo framework** — Same TUI layout works for both subjects with subject-specific health polling and chaos injection
6. **AI diagnosis quality** — Claude reasons about rate limiter anomalies (counter drift, ghost allowing) without rate-limiter-specific prompts in operator-core

## Stats

- 146 files changed
- ~18,000 lines added (net)
- 5 phases, 21 plans
- 87 commits
- 2 days from start to ship (2026-01-26 to 2026-01-27)

## Phase Details

### Phase 16: Core Abstraction Refactoring

**Goal:** Decouple operator-core from TiKV-specific types so any Subject can be monitored

**Plans:**
- 16-01: Create operator-protocols package with generic protocols
- 16-02: Update operator-tikv to implement new protocols
- 16-03: Update operator-core to use protocols (remove TiKV imports)
- 16-04: Add --subject CLI flag and factory pattern
- 16-05: Protocol compliance tests (26 new tests)

**Requirements covered:** CORE-01 through CORE-05

### Phase 17: Rate Limiter Service Foundation

**Goal:** Build the custom rate limiter service that will be monitored by operator-ratelimiter

**Plans:**
- 17-01: Package setup with config and Redis client
- 17-02: Sliding window rate limiter with Lua script
- 17-03: API endpoints, Prometheus metrics, and FastAPI app
- 17-04: Wire unused metrics (gap closure)

**Requirements covered:** RLSVC-01 through RLSVC-04

### Phase 18: Docker Compose Environment

**Goal:** Create reproducible development environment for rate limiter cluster

**Plans:**
- 18-01: Docker Compose infrastructure (Dockerfile, docker-compose.yml, Prometheus)
- 18-02: Load generator with configurable traffic patterns

**Requirements covered:** RLSVC-05, DEMO-01

### Phase 19: operator-ratelimiter Package

**Goal:** Implement Subject Protocol for rate limiter with invariants and actions

**Plans:**
- 19-01: Package foundation (types, HTTP/Redis/Prom clients)
- 19-02: RateLimiterSubject and RateLimiterInvariantChecker
- 19-03: Add reset counter API endpoint to ratelimiter-service
- 19-04: Factory function and CLI integration
- 19-05: Protocol compliance and unit tests (65 tests)

**Requirements covered:** RLPKG-01 through RLPKG-04, MON-01 through MON-05, ACT-01, ACT-02

### Phase 20: E2E Demo & Chaos

**Goal:** Validate that AI can diagnose rate limiter anomalies without system-specific prompts

**Plans:**
- 20-01: Shared demo infrastructure (Chapter, ChaosConfig, DemoRunner)
- 20-02: TiKV demo entry point with chapters and chaos
- 20-03: Rate limiter demo with counter drift and ghost allowing chaos
- 20-04: TUI integration and run-demo script
- 20-05: E2E validation (human verified)

**Requirements covered:** DEMO-02, DEMO-03, DEMO-04

## Key Technical Decisions

1. **Observation type is dict[str, Any]** — Maximum flexibility across subjects
2. **operator-protocols has zero dependencies** — Can be imported anywhere
3. **Factory returns tuple (subject, checker)** — CLI convenience
4. **Lazy imports in subject_factory.py** — Only loads operator-ratelimiter when needed
5. **Pydantic-settings for env config** — RATELIMITER_ prefix for all settings
6. **Lua script atomic counters** — Sliding window + sequence numbers prevent races
7. **Grace periods for invariants** — 60s latency, 30s drift to prevent false alarms
8. **Redis CLIENT PAUSE WRITE** — Allows health checks during chaos
9. **Subject detection from health dict** — No explicit subject parameter needed for formatting

## Git Range

`bb2b7a9` (feat(16-01): create operator-protocols package structure) → `4711c78` (chore: remove debug prints from demo)

---
*Archived: 2026-01-27*
