---
phase: 03-local-cluster
plan: 04
type: execute
wave: 3
depends_on: ["03-01", "03-02"]
files_modified:
  - subjects/tikv/Dockerfile.operator
  - subjects/tikv/docker-compose.yaml
autonomous: false

must_haves:
  truths:
    - "Operator container builds with operator-core and operator-tikv packages"
    - "Operator container can query PD API inside Docker network"
    - "Operator container can query Prometheus inside Docker network"
    - "operator deploy local status works from inside container"
  artifacts:
    - path: "subjects/tikv/Dockerfile.operator"
      provides: "Operator Docker image with Python packages"
      contains: "operator-core"
  key_links:
    - from: "operator service"
      to: "pd0:2379"
      via: "PDClient connection"
      pattern: "pd0:2379"
    - from: "operator service"
      to: "prometheus:9090"
      via: "PrometheusClient connection"
      pattern: "prometheus:9090"
---

<objective>
Add a containerized operator service that runs alongside the TiKV cluster.

Purpose: ENV-04 requires the operator itself to run in Docker, connecting to the cluster and observability stack without host dependencies.

Output: Operator Dockerfile and docker-compose service that can observe the TiKV cluster from within the Docker network.
</objective>

<execution_context>
@/Users/jrtipton/.claude/get-shit-done/workflows/execute-plan.md
@/Users/jrtipton/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/03-local-cluster/03-RESEARCH.md
@.planning/phases/02-tikv-subject/02-05-SUMMARY.md

# Prior plan outputs
@subjects/tikv/docker-compose.yaml
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create operator Dockerfile</name>
  <files>subjects/tikv/Dockerfile.operator</files>
  <action>
Create a Dockerfile that packages the operator Python application:

**subjects/tikv/Dockerfile.operator:**
```dockerfile
FROM python:3.11-slim

# Install uv for dependency management
COPY --from=ghcr.io/astral-sh/uv:latest /uv /usr/local/bin/uv

WORKDIR /app

# Copy workspace files
COPY pyproject.toml uv.lock ./
COPY packages/ ./packages/

# Install dependencies using uv
RUN uv sync --frozen

# Set default command
CMD ["uv", "run", "python", "-c", "print('Operator ready')"]
```

The Dockerfile:
- Uses Python 3.11 slim base image
- Installs uv via multi-stage copy from official image
- Copies the full workspace (pyproject.toml, uv.lock, packages/)
- Runs uv sync to install all packages
- Default command is a placeholder (real command will vary by use case)
  </action>
  <verify>
ls -la subjects/tikv/Dockerfile.operator
# File should exist
  </verify>
  <done>Dockerfile.operator created with uv-based Python setup</done>
</task>

<task type="auto">
  <name>Task 2: Add operator service to docker-compose</name>
  <files>subjects/tikv/docker-compose.yaml</files>
  <action>
Add the operator service to docker-compose.yaml:

**operator service:**
- Build:
  - context: `../..` (workspace root - two levels up from subjects/tikv/)
  - dockerfile: `subjects/tikv/Dockerfile.operator`
- Container name: operator
- Environment:
  - `PD_ENDPOINT=http://pd0:2379`
  - `PROMETHEUS_URL=http://prometheus:9090`
- depends_on:
  - tikv0, tikv1, tikv2 with condition: service_healthy
  - prometheus (no condition, just dependency order)
- profiles: ["operator"] (doesn't start by default, run with --profile operator)
- Command: `uv run python -c "print('Operator container ready')"` (placeholder)

Build the image:
```bash
docker compose -f subjects/tikv/docker-compose.yaml build operator
```
  </action>
  <verify>
docker compose -f subjects/tikv/docker-compose.yaml config --quiet
docker images | grep operator
# Image should exist after build
  </verify>
  <done>operator service added to docker-compose.yaml and image builds successfully</done>
</task>

<task type="auto">
  <name>Task 3: Verify operator can connect to cluster services</name>
  <files></files>
  <action>
Start the cluster and verify the operator container can access services:

1. Start the full cluster: `docker compose -f subjects/tikv/docker-compose.yaml up -d`
2. Wait for cluster to be healthy
3. Run the operator container with a test command:
```bash
docker compose -f subjects/tikv/docker-compose.yaml run --rm operator \
  uv run python -c "
import httpx
import asyncio

async def test():
    async with httpx.AsyncClient() as client:
        # Test PD connection
        pd = await client.get('http://pd0:2379/pd/api/v1/stores')
        print(f'PD stores: {pd.status_code}')

        # Test Prometheus connection
        prom = await client.get('http://prometheus:9090/api/v1/targets')
        print(f'Prometheus targets: {prom.status_code}')

asyncio.run(test())
"
```
4. Verify both return 200 status codes

After verification, stop the cluster: `docker compose -f subjects/tikv/docker-compose.yaml down`
  </action>
  <verify>
# Both PD and Prometheus should return 200
  </verify>
  <done>Operator container successfully connects to PD API and Prometheus within Docker network</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Complete local cluster environment:
- 3 PD nodes + 3 TiKV nodes (docker-compose)
- Prometheus scraping all nodes
- Grafana with Prometheus datasource
- go-ycsb load generator (on-demand)
- Operator container with Python packages
  </what-built>
  <how-to-verify>
1. Start full stack:
   ```bash
   cd subjects/tikv
   docker compose up -d
   ```

2. Wait ~60 seconds for cluster to stabilize

3. Verify cluster health:
   ```bash
   curl http://localhost:2379/pd/api/v1/stores | jq '.stores[].store.state_name'
   # Should show "Up" for all 3 stores
   ```

4. Verify Prometheus targets (open in browser):
   http://localhost:9090/targets
   # Should show 6 targets (3 pd, 3 tikv) all "up"

5. Verify Grafana access (open in browser):
   http://localhost:3000
   # Login: admin/admin
   # Should see Prometheus datasource

6. Run a quick load test:
   ```bash
   docker compose run --rm ycsb load tikv \
     -P /workloads/workloada \
     -p tikv.pd="pd0:2379,pd1:2379,pd2:2379" \
     -p tikv.type="raw" \
     -p recordcount=100 \
     -p threadcount=2
   ```
   # Should complete without errors

7. Stop everything:
   ```bash
   docker compose down
   ```
  </how-to-verify>
  <resume-signal>Type "approved" if cluster, observability, and load generator all work, or describe any issues</resume-signal>
</task>

</tasks>

<verification>
1. Dockerfile.operator builds successfully
2. operator service in docker-compose.yaml
3. Operator container can reach pd0:2379
4. Operator container can reach prometheus:9090
5. Human verification of complete stack
</verification>

<success_criteria>
- Operator Docker image builds with all Python packages
- Operator container runs within Docker network
- PD API accessible from operator container
- Prometheus accessible from operator container
- Complete stack verified by human (ENV-01, ENV-02, ENV-03, ENV-04 all satisfied)
</success_criteria>

<output>
After completion, create `.planning/phases/03-local-cluster/03-04-SUMMARY.md`
</output>
