---
phase: 03-local-cluster
plan: 02
type: execute
wave: 2
depends_on: ["03-01"]
files_modified:
  - subjects/tikv/docker-compose.yaml
  - subjects/tikv/config/prometheus.yml
  - subjects/tikv/config/grafana/datasources.yml
autonomous: true

must_haves:
  truths:
    - "Prometheus scrapes metrics from all PD and TiKV nodes"
    - "Prometheus UI accessible on localhost:9090"
    - "Grafana UI accessible on localhost:3000"
    - "Grafana has Prometheus as default datasource"
  artifacts:
    - path: "subjects/tikv/config/prometheus.yml"
      provides: "Prometheus scrape configuration"
      contains: "job_name: 'tikv'"
    - path: "subjects/tikv/config/grafana/datasources.yml"
      provides: "Grafana datasource provisioning"
      contains: "type: prometheus"
  key_links:
    - from: "prometheus service"
      to: "tikv0:20180, tikv1:20180, tikv2:20180"
      via: "static_configs targets"
      pattern: "tikv.*:20180"
    - from: "grafana service"
      to: "prometheus:9090"
      via: "datasource url"
      pattern: "http://prometheus:9090"
---

<objective>
Add Prometheus and Grafana to the TiKV cluster for metrics collection and visualization.

Purpose: ENV-02 requires containerized observability with Prometheus scraping TiKV/PD metrics and Grafana providing dashboards.

Output: Updated docker-compose.yaml with Prometheus and Grafana services, plus configuration files for scraping and datasource provisioning.
</objective>

<execution_context>
@/Users/jrtipton/.claude/get-shit-done/workflows/execute-plan.md
@/Users/jrtipton/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/03-local-cluster/03-RESEARCH.md

# Prior plan output (cluster definition)
@subjects/tikv/docker-compose.yaml
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Prometheus and Grafana configuration files</name>
  <files>
subjects/tikv/config/prometheus.yml
subjects/tikv/config/grafana/datasources.yml
  </files>
  <action>
Create the config directory structure and files:

**subjects/tikv/config/prometheus.yml:**
```yaml
global:
  scrape_interval: 15s
  evaluation_interval: 15s

scrape_configs:
  - job_name: 'pd'
    honor_labels: true
    static_configs:
      - targets:
        - 'pd0:2379'
        - 'pd1:2379'
        - 'pd2:2379'

  - job_name: 'tikv'
    honor_labels: true
    static_configs:
      - targets:
        - 'tikv0:20180'
        - 'tikv1:20180'
        - 'tikv2:20180'
```

**subjects/tikv/config/grafana/datasources.yml:**
```yaml
apiVersion: 1
datasources:
  - name: Prometheus
    type: prometheus
    access: proxy
    url: http://prometheus:9090
    isDefault: true
    editable: false
```

Match the patterns from 03-RESEARCH.md exactly. Use port 20180 for TiKV (status/metrics), not 20160 (gRPC).
  </action>
  <verify>
ls -la subjects/tikv/config/prometheus.yml subjects/tikv/config/grafana/datasources.yml
# Both files should exist
  </verify>
  <done>Config files created with correct scrape targets and datasource configuration</done>
</task>

<task type="auto">
  <name>Task 2: Add Prometheus and Grafana services to docker-compose</name>
  <files>subjects/tikv/docker-compose.yaml</files>
  <action>
Add Prometheus and Grafana services to the existing docker-compose.yaml:

**Prometheus service:**
- Image: `prom/prometheus:latest` (multi-arch)
- Container name: prometheus
- Ports: 9090:9090
- Volumes:
  - `./config/prometheus.yml:/etc/prometheus/prometheus.yml:ro`
  - `prometheus-data:/prometheus`
- Command:
  - `--config.file=/etc/prometheus/prometheus.yml`
  - `--storage.tsdb.path=/prometheus`
  - `--storage.tsdb.retention.time=15d`
  - `--web.enable-lifecycle`
- depends_on: tikv0 with condition: service_healthy (wait for cluster)
- Restart: on-failure

**Grafana service:**
- Image: `grafana/grafana:latest` (multi-arch)
- Container name: grafana
- Ports: 3000:3000
- Volumes:
  - `./config/grafana/datasources.yml:/etc/grafana/provisioning/datasources/datasources.yml:ro`
  - `grafana-data:/var/lib/grafana`
- Environment:
  - `GF_SECURITY_ADMIN_PASSWORD=admin`
- depends_on: prometheus (wait for prometheus)
- Restart: on-failure

**Add to volumes section:**
- prometheus-data:
- grafana-data:

Keep all existing PD and TiKV services unchanged.
  </action>
  <verify>
docker compose -f subjects/tikv/docker-compose.yaml config --quiet
# Should exit 0 (valid compose file)
  </verify>
  <done>docker-compose.yaml includes prometheus and grafana services with correct volume mounts</done>
</task>

<task type="auto">
  <name>Task 3: Verify observability stack is functional</name>
  <files></files>
  <action>
Start the full stack and verify observability works:

1. Start cluster: `docker compose -f subjects/tikv/docker-compose.yaml up -d`
2. Wait for all services to be healthy (poll until prometheus and grafana are running)
3. Verify Prometheus is scraping targets:
   - `curl http://localhost:9090/api/v1/targets`
   - Check that pd and tikv jobs show targets as "up"
4. Verify Grafana is accessible:
   - `curl -s http://localhost:3000/api/health` returns `{"database":"ok"}`
5. Verify Grafana has Prometheus datasource:
   - `curl -s -u admin:admin http://localhost:3000/api/datasources` includes Prometheus

After verification, stop the cluster: `docker compose -f subjects/tikv/docker-compose.yaml down`
  </action>
  <verify>
# Prometheus targets should be up
curl -s http://localhost:9090/api/v1/targets | grep -c '"health":"up"'
# Should be 6 (3 PD + 3 TiKV)
  </verify>
  <done>Prometheus scrapes all 6 targets, Grafana accessible with Prometheus datasource configured</done>
</task>

</tasks>

<verification>
1. Config files exist: prometheus.yml, grafana/datasources.yml
2. docker-compose.yaml includes prometheus and grafana services
3. `curl http://localhost:9090/api/v1/targets` shows 6 targets up
4. `curl http://localhost:3000/api/health` returns database:ok
5. Grafana datasource API returns Prometheus
</verification>

<success_criteria>
- Prometheus config file scrapes all 6 nodes (3 PD + 3 TiKV)
- Grafana datasource provisioning file configures Prometheus
- docker-compose.yaml includes prometheus and grafana services
- All Prometheus targets show as "up"
- Grafana UI accessible on port 3000
</success_criteria>

<output>
After completion, create `.planning/phases/03-local-cluster/03-02-SUMMARY.md`
</output>
