---
phase: 03-local-cluster
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - subjects/tikv/docker-compose.yaml
autonomous: true

must_haves:
  truths:
    - "docker compose up starts a 3-node PD cluster"
    - "docker compose up starts a 3-node TiKV cluster after PD is healthy"
    - "PD API responds on localhost:2379 with cluster health"
    - "All TiKV stores show state 'Up' in PD API"
  artifacts:
    - path: "subjects/tikv/docker-compose.yaml"
      provides: "Complete PD + TiKV cluster definition"
      contains: "pingcap/pd-arm64"
  key_links:
    - from: "tikv0 service"
      to: "pd0, pd1, pd2 services"
      via: "depends_on: condition: service_healthy"
      pattern: "depends_on.*service_healthy"
---

<objective>
Replace the Phase 1 stub docker-compose.yaml with a production-like TiKV cluster configuration.

Purpose: ENV-01 requires a 6-node cluster (3 PD, 3 TiKV) for testing the operator against real distributed system behavior.

Output: A docker-compose.yaml that starts a complete TiKV cluster with proper networking, health checks, and startup ordering.
</objective>

<execution_context>
@/Users/jrtipton/.claude/get-shit-done/workflows/execute-plan.md
@/Users/jrtipton/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/03-local-cluster/03-RESEARCH.md

# Existing file to replace
@subjects/tikv/docker-compose.yaml
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create TiKV/PD cluster docker-compose.yaml</name>
  <files>subjects/tikv/docker-compose.yaml</files>
  <action>
Replace the stub docker-compose.yaml with a complete cluster definition:

**PD Cluster (3 nodes: pd0, pd1, pd2):**
- Image: `pingcap/pd-arm64:latest` (ARM64 native for OrbStack)
- Only pd0 exposes port 2379 to host (single entry point)
- Each PD has named volume for data persistence
- Command arguments:
  - `--name=pdN` (node name)
  - `--data-dir=/data`
  - `--client-urls=http://0.0.0.0:2379`
  - `--advertise-client-urls=http://pdN:2379`
  - `--peer-urls=http://0.0.0.0:2380`
  - `--advertise-peer-urls=http://pdN:2380`
  - `--initial-cluster=pd0=http://pd0:2380,pd1=http://pd1:2380,pd2=http://pd2:2380`
- Healthcheck: wget to `http://localhost:2379/pd/api/v1/health`
- Restart: on-failure

**TiKV Cluster (3 nodes: tikv0, tikv1, tikv2):**
- Image: `pingcap/tikv-arm64:latest`
- Only tikv0 exposes ports 20160 (gRPC) and 20180 (status) to host
- Each TiKV has named volume for data persistence
- Command arguments:
  - `--addr=0.0.0.0:20160`
  - `--advertise-addr=tikvN:20160`
  - `--status-addr=0.0.0.0:20180`
  - `--advertise-status-addr=tikvN:20180`
  - `--data-dir=/data`
  - `--pd=pd0:2379,pd1:2379,pd2:2379`
- depends_on: all 3 PD nodes with `condition: service_healthy`
- Healthcheck: wget to `http://localhost:20180/status`
- Restart: on-failure

**Volumes section:**
- pd0-data, pd1-data, pd2-data
- tikv0-data, tikv1-data, tikv2-data

Use YAML multiline `>` for command to keep it readable. Match the patterns from 03-RESEARCH.md exactly.
  </action>
  <verify>
docker compose -f subjects/tikv/docker-compose.yaml config --quiet
# Should exit 0 (valid compose file)
  </verify>
  <done>Valid docker-compose.yaml with 3 PD + 3 TiKV services, all with correct args and healthchecks</done>
</task>

<task type="auto">
  <name>Task 2: Verify cluster starts and reaches healthy state</name>
  <files></files>
  <action>
Start the cluster and verify it becomes healthy:

1. Run `docker compose -f subjects/tikv/docker-compose.yaml up -d`
2. Wait for all containers to start (poll with docker compose ps)
3. Wait for PD health endpoint: `curl http://localhost:2379/pd/api/v1/health`
4. Wait for stores to register: `curl http://localhost:2379/pd/api/v1/stores`
5. Verify all 3 stores show `"state_name": "Up"`

Expected timeline:
- PD nodes healthy: ~10-15 seconds
- TiKV nodes healthy: ~30-60 seconds (start_period is 30s)

If any container exits, capture logs with `docker compose logs` before reporting failure.

After verification, stop the cluster: `docker compose -f subjects/tikv/docker-compose.yaml down`
  </action>
  <verify>
# All 3 stores should be Up
curl -s http://localhost:2379/pd/api/v1/stores | grep -c '"state_name": "Up"'
# Should output: 3
  </verify>
  <done>Cluster starts successfully with all 3 TiKV stores in Up state, then cleanly shuts down</done>
</task>

</tasks>

<verification>
1. `docker compose -f subjects/tikv/docker-compose.yaml config` validates syntax
2. `docker compose up -d` starts all 6 containers
3. `curl http://localhost:2379/pd/api/v1/health` returns 200
4. `curl http://localhost:2379/pd/api/v1/stores` shows 3 stores in Up state
5. `docker compose down` cleanly stops all containers
</verification>

<success_criteria>
- docker-compose.yaml exists with 3 PD + 3 TiKV services
- ARM64 images used (pingcap/pd-arm64, pingcap/tikv-arm64)
- Healthcheck-based startup ordering (TiKV waits for PD)
- Cluster verified to start and reach healthy state
- All containers stop cleanly
</success_criteria>

<output>
After completion, create `.planning/phases/03-local-cluster/03-01-SUMMARY.md`
</output>
