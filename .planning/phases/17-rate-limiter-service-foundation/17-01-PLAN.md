---
phase: 17-rate-limiter-service-foundation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - packages/ratelimiter-service/pyproject.toml
  - packages/ratelimiter-service/src/ratelimiter_service/__init__.py
  - packages/ratelimiter-service/src/ratelimiter_service/config.py
  - packages/ratelimiter-service/src/ratelimiter_service/redis_client.py
autonomous: true

must_haves:
  truths:
    - "Package can be installed with pip install -e"
    - "Configuration loads from environment variables"
    - "Async Redis client connects to Redis server"
  artifacts:
    - path: "packages/ratelimiter-service/pyproject.toml"
      provides: "Package definition with FastAPI, redis, prometheus dependencies"
      contains: "ratelimiter-service"
    - path: "packages/ratelimiter-service/src/ratelimiter_service/config.py"
      provides: "Environment-based configuration"
      contains: "Settings"
    - path: "packages/ratelimiter-service/src/ratelimiter_service/redis_client.py"
      provides: "Async Redis connection management"
      contains: "get_redis"
  key_links:
    - from: "config.py"
      to: "redis_client.py"
      via: "Settings.redis_url used for connection"
      pattern: "settings\\.redis_url"
---

<objective>
Create the ratelimiter-service package foundation with configuration and async Redis client.

Purpose: Establish the package structure following existing patterns (operator-tikv) and provide the Redis connection foundation that all rate limiting logic depends on.

Output: Installable Python package with environment-based config and async Redis client.
</objective>

<execution_context>
@/Users/jrtipton/.claude/get-shit-done/workflows/execute-plan.md
@/Users/jrtipton/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/17-rate-limiter-service-foundation/17-RESEARCH.md

# Existing package patterns
@packages/operator-tikv/pyproject.toml
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create package structure</name>
  <files>
    packages/ratelimiter-service/pyproject.toml
    packages/ratelimiter-service/src/ratelimiter_service/__init__.py
  </files>
  <action>
Create the ratelimiter-service package following operator-tikv patterns:

1. Create `packages/ratelimiter-service/pyproject.toml`:
   - name: "ratelimiter-service"
   - version: "0.1.0"
   - description: "Custom distributed rate limiter service for operator demo"
   - requires-python: ">=3.11"
   - dependencies (from RESEARCH.md):
     - fastapi>=0.115.0
     - uvicorn>=0.32.0
     - redis>=5.0.0
     - prometheus-fastapi-instrumentator>=7.0.0
     - pydantic>=2.0.0
   - build-system: hatchling (same as other packages)
   - [tool.hatch.build.targets.wheel] packages = ["src/ratelimiter_service"]

2. Create `packages/ratelimiter-service/src/ratelimiter_service/__init__.py`:
   - Add package docstring
   - Export __version__ = "0.1.0"

3. Create empty directories:
   - packages/ratelimiter-service/src/ratelimiter_service/api/
   - packages/ratelimiter-service/tests/

Note: This package is standalone (not a dependency of operator-core). It will be monitored BY operator-ratelimiter (Phase 19), not imported by it.
  </action>
  <verify>
    cd /Users/jrtipton/x/operator && pip install -e packages/ratelimiter-service && python -c "import ratelimiter_service; print(ratelimiter_service.__version__)"
  </verify>
  <done>Package installs successfully and version prints "0.1.0"</done>
</task>

<task type="auto">
  <name>Task 2: Create config and Redis client</name>
  <files>
    packages/ratelimiter-service/src/ratelimiter_service/config.py
    packages/ratelimiter-service/src/ratelimiter_service/redis_client.py
  </files>
  <action>
Create configuration and async Redis client:

1. Create `config.py` with Pydantic Settings:
```python
from pydantic_settings import BaseSettings

class Settings(BaseSettings):
    # Redis
    redis_url: str = "redis://localhost:6379"

    # Node identity
    node_id: str = "node-1"
    node_host: str = "localhost"
    node_port: int = 8000

    # Rate limiting defaults
    default_limit: int = 100
    default_window_ms: int = 60000  # 60 seconds

    # Node registration
    node_ttl_seconds: int = 30
    node_heartbeat_seconds: int = 10

    class Config:
        env_prefix = "RATELIMITER_"

settings = Settings()
```

2. Create `redis_client.py` with async Redis connection:
```python
import redis.asyncio as redis
from contextlib import asynccontextmanager
from .config import settings

_redis_pool: redis.ConnectionPool | None = None

async def init_redis_pool() -> None:
    """Initialize Redis connection pool. Call on app startup."""
    global _redis_pool
    _redis_pool = redis.ConnectionPool.from_url(
        settings.redis_url,
        decode_responses=True,
    )

async def close_redis_pool() -> None:
    """Close Redis connection pool. Call on app shutdown."""
    global _redis_pool
    if _redis_pool:
        await _redis_pool.disconnect()
        _redis_pool = None

async def get_redis() -> redis.Redis:
    """Get Redis client from pool. Use as FastAPI dependency."""
    if _redis_pool is None:
        raise RuntimeError("Redis pool not initialized")
    return redis.Redis(connection_pool=_redis_pool)
```

Note: Use `redis.asyncio` (not aioredis - merged into redis-py). Set `decode_responses=True` for string returns instead of bytes.
  </action>
  <verify>
    cd /Users/jrtipton/x/operator && python -c "from ratelimiter_service.config import settings; print(f'Redis URL: {settings.redis_url}, Default limit: {settings.default_limit}')"
  </verify>
  <done>Config loads with defaults, Redis client module imports without error</done>
</task>

</tasks>

<verification>
1. Package installed: `pip list | grep ratelimiter-service`
2. Config works: `python -c "from ratelimiter_service.config import settings; print(settings.model_dump())"`
3. Redis client imports: `python -c "from ratelimiter_service.redis_client import get_redis, init_redis_pool"`
</verification>

<success_criteria>
- ratelimiter-service package installs without errors
- Settings class loads configuration from environment variables
- Redis client module provides async connection management functions
- Package structure matches operator-tikv patterns
</success_criteria>

<output>
After completion, create `.planning/phases/17-rate-limiter-service-foundation/17-01-SUMMARY.md`
</output>
