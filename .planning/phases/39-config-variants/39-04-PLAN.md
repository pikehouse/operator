---
phase: 39-config-variants
plan: 04
type: execute
wave: 1
depends_on: []
files_modified:
  - eval/src/eval/runner/harness.py
  - packages/operator-core/src/operator_core/agent_lab/loop.py
  - packages/operator-core/src/operator_core/agent_lab/__init__.py
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "Trial runner uses variant config for agent execution"
    - "Agent loop accepts model, system_prompt, tools_config parameters"
    - "Variant config flows from harness through run_trial to process_ticket"
  artifacts:
    - path: "eval/src/eval/runner/harness.py"
      provides: "run_trial accepts variant_config parameter and passes to agent"
      contains: "variant_config: VariantConfig"
    - path: "packages/operator-core/src/operator_core/agent_lab/loop.py"
      provides: "process_ticket accepts variant override parameters"
      contains: "model: str | None = None"
  key_links:
    - from: "eval/src/eval/runner/harness.py"
      to: "packages/operator-core/src/operator_core/agent_lab/loop.py"
      via: "variant config parameters passed to process_ticket"
      pattern: "process_ticket.*model.*system_prompt"
---

<objective>
Close the gap where variant_config is loaded but not applied during trial execution.

Purpose: Enable actual A/B testing of agent configurations - model, system_prompt, and tools_config should be used from the variant instead of hardcoded values.

Output: Variant config flows from campaign YAML through harness, run_trial, to the agent loop where it configures the Anthropic API call.
</objective>

<execution_context>
@/Users/jrtipton/.claude/get-shit-done/workflows/execute-plan.md
@/Users/jrtipton/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Gap being closed
@.planning/phases/39-config-variants/39-VERIFICATION.md

# Prior phase context
@.planning/phases/39-config-variants/39-02-SUMMARY.md

# Files to modify
@eval/src/eval/runner/harness.py
@packages/operator-core/src/operator_core/agent_lab/loop.py
@packages/operator-core/src/operator_core/agent_lab/__init__.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add variant_config parameter to run_trial and pass from harness</name>
  <files>eval/src/eval/runner/harness.py</files>
  <action>
Modify run_trial() function signature to accept variant_config:

1. Add import for VariantConfig at top of file (already imported from eval.types)

2. Update run_trial signature (line 124):
```python
async def run_trial(
    subject: EvalSubject,
    chaos_type: str,
    campaign_id: int,
    baseline: bool = False,
    operator_db_path: Path | None = None,
    chaos_params: dict[str, Any] | None = None,
    variant_config: VariantConfig | None = None,  # NEW
) -> Trial:
```

3. In run_campaign_from_config(), pass variant_config to run_trial (around line 340):
```python
trial = await run_trial(
    subject=subject,
    chaos_type=spec["chaos_type"] if not spec["baseline"] else "none",
    campaign_id=campaign_id,
    baseline=spec["baseline"],
    operator_db_path=operator_db_path,
    chaos_params=spec["chaos_params"],
    variant_config=variant_config,  # NEW
)
```

4. In run_trial, before the "Wait for resolution" section (around line 180), add logic to call the agent with variant config:
```python
if not baseline and variant_config:
    # Import here to avoid circular dependency
    from operator_core.agent_lab.loop import process_ticket_with_variant
    # Note: process_ticket_with_variant will be added in Task 2
    # This shows the integration point - actual agent call goes here
    pass  # Agent integration handled via operator DB polling
```

Note: The actual agent runs as a separate process that polls operator.db for tickets. The variant_config determines HOW that agent should be configured when started. For now, we just ensure the variant_config is passed through the harness correctly. The agent loop modification in Task 2 will add the ability to configure the agent with variant parameters.
  </action>
  <verify>
    python -c "from eval.runner.harness import run_trial; import inspect; sig = inspect.signature(run_trial); print([p for p in sig.parameters])"
    # Should show: ['subject', 'chaos_type', 'campaign_id', 'baseline', 'operator_db_path', 'chaos_params', 'variant_config']
  </verify>
  <done>run_trial accepts variant_config parameter and harness passes it from campaign config</done>
</task>

<task type="auto">
  <name>Task 2: Modify process_ticket to accept variant override parameters</name>
  <files>packages/operator-core/src/operator_core/agent_lab/loop.py, packages/operator-core/src/operator_core/agent_lab/__init__.py</files>
  <action>
Modify process_ticket() to accept optional variant parameters that override defaults:

1. Update process_ticket signature in loop.py:
```python
def process_ticket(
    client: anthropic.Anthropic,
    ticket: Ticket,
    audit_db: AuditLogDB,
    session_id: str,
    model: str | None = None,  # NEW: Override model
    system_prompt_override: str | None = None,  # NEW: Override system prompt
    tools_config: dict | None = None,  # NEW: Tool configuration
) -> tuple[str, str]:
```

2. Replace hardcoded model/prompt with parameters (around line 43-54):
```python
# Build system prompt with subject context if available
effective_system_prompt = system_prompt_override if system_prompt_override else SYSTEM_PROMPT
if ticket.subject_context:
    effective_system_prompt += "\n\n" + ticket.subject_context

# Use variant model or default
effective_model = model if model else "claude-opus-4-20250514"

# Run Claude with tool_runner
runner = client.beta.messages.tool_runner(
    model=effective_model,
    max_tokens=8192,
    tools=[shell],
    system=effective_system_prompt,
    messages=[{"role": "user", "content": ticket_text}],
)
```

3. Update the call to process_ticket in run_agent_loop (around line 151):
   Keep the existing call unchanged for backward compatibility - the parameters have defaults.

4. Add process_ticket to __init__.py exports:
```python
from .loop import run_agent_loop, process_ticket
```

And add to __all__:
```python
__all__ = [
    "run_agent_loop",
    "process_ticket",  # NEW
    "shell",
    ...
]
```
  </action>
  <verify>
    python -c "from operator_core.agent_lab import process_ticket; import inspect; sig = inspect.signature(process_ticket); print([p for p in sig.parameters])"
    # Should show: ['client', 'ticket', 'audit_db', 'session_id', 'model', 'system_prompt_override', 'tools_config']
  </verify>
  <done>process_ticket accepts model, system_prompt_override, tools_config parameters with backward-compatible defaults</done>
</task>

<task type="auto">
  <name>Task 3: Wire variant config from harness through to agent execution</name>
  <files>eval/src/eval/runner/harness.py</files>
  <action>
Update run_campaign_from_config to pass variant config parameters when spawning agent:

Since the agent runs as a separate process (started via CLI, polling for tickets), the integration point is:
1. The harness knows the variant config
2. The harness needs to communicate variant to the agent

There are two approaches:
A) Environment variables (agent reads on startup)
B) Write variant config to a file the agent reads

For this gap closure, use approach A (simpler, no file I/O):

1. In run_campaign_from_config, after loading variant_config (line 305), set environment variables:
```python
import os

# Load variant configuration
try:
    variant_config = get_variant(config.variant)
    console.print(f"[dim]Using variant: {variant_config.name} (model: {variant_config.model})[/dim]")

    # Set env vars for agent to pick up (if running in same process)
    os.environ["OPERATOR_VARIANT_MODEL"] = variant_config.model
    os.environ["OPERATOR_VARIANT_SYSTEM_PROMPT"] = variant_config.system_prompt
    os.environ["OPERATOR_VARIANT_TOOLS_CONFIG"] = json.dumps(variant_config.tools_config)
except ValueError as e:
    console.print(f"[red]Error loading variant: {e}[/red]")
    raise
```

2. Update process_ticket in loop.py to read env vars as fallback:
```python
import os

def process_ticket(
    client: anthropic.Anthropic,
    ticket: Ticket,
    audit_db: AuditLogDB,
    session_id: str,
    model: str | None = None,
    system_prompt_override: str | None = None,
    tools_config: dict | None = None,
) -> tuple[str, str]:
    # Use explicit params > env vars > defaults
    effective_model = (
        model
        or os.environ.get("OPERATOR_VARIANT_MODEL")
        or "claude-opus-4-20250514"
    )
    effective_system_prompt = (
        system_prompt_override
        or os.environ.get("OPERATOR_VARIANT_SYSTEM_PROMPT")
        or SYSTEM_PROMPT
    )
```

This creates the integration path: harness sets env vars -> agent reads them.
  </action>
  <verify>
    cd /Users/jrtipton/x/operator && python -c "
import os
os.environ['OPERATOR_VARIANT_MODEL'] = 'claude-test-model'
from operator_core.agent_lab.loop import process_ticket
import inspect
# Just verify the env var reading logic is there
print('process_ticket exists and uses env vars for model fallback')
"
  </verify>
  <done>Variant config flows from harness via env vars to agent, enabling different model/prompt configurations per campaign</done>
</task>

</tasks>

<verification>
After all tasks complete:

1. Verify run_trial accepts variant_config:
```bash
cd /Users/jrtipton/x/operator && python -c "
from eval.runner.harness import run_trial
import inspect
sig = inspect.signature(run_trial)
params = list(sig.parameters.keys())
assert 'variant_config' in params, 'variant_config not in run_trial'
print('PASS: run_trial has variant_config parameter')
"
```

2. Verify process_ticket accepts variant params:
```bash
cd /Users/jrtipton/x/operator && python -c "
from operator_core.agent_lab import process_ticket
import inspect
sig = inspect.signature(process_ticket)
params = list(sig.parameters.keys())
assert 'model' in params, 'model not in process_ticket'
assert 'system_prompt_override' in params, 'system_prompt_override not in process_ticket'
print('PASS: process_ticket has variant parameters')
"
```

3. Verify env var integration:
```bash
cd /Users/jrtipton/x/operator && python -c "
import os
os.environ['OPERATOR_VARIANT_MODEL'] = 'claude-test-model'
os.environ['OPERATOR_VARIANT_SYSTEM_PROMPT'] = 'Test prompt'
# Import after setting env vars
from operator_core.agent_lab.loop import process_ticket
print('PASS: env var integration works')
"
```
</verification>

<success_criteria>
- run_trial() signature includes variant_config: VariantConfig | None parameter
- process_ticket() accepts model, system_prompt_override, tools_config parameters
- Harness sets OPERATOR_VARIANT_* environment variables from variant config
- Agent loop reads env vars as fallback for model/prompt configuration
- Gap closed: variant config is actually used during trial execution (via env vars)
</success_criteria>

<output>
After completion, create `.planning/phases/39-config-variants/39-04-SUMMARY.md`
</output>
