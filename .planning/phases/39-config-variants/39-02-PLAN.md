---
phase: 39-config-variants
plan: 02
type: execute
wave: 2
depends_on: ["39-01"]
files_modified:
  - eval/src/eval/runner/campaign.py
  - eval/src/eval/runner/db.py
  - eval/src/eval/runner/harness.py
  - eval/src/eval/types.py
  - eval/src/eval/cli.py
autonomous: true

must_haves:
  truths:
    - "Campaign YAML can specify variant field"
    - "Campaigns table stores variant_name"
    - "Trial runner uses variant config for agent"
    - "Campaign omitting variant uses 'default'"
  artifacts:
    - path: "eval/src/eval/runner/campaign.py"
      provides: "CampaignConfig with variant field"
      contains: "variant:"
    - path: "eval/src/eval/runner/db.py"
      provides: "Schema migration for variant_name column"
      contains: "variant_name"
    - path: "eval/src/eval/runner/harness.py"
      provides: "Variant integration in trial runner"
      contains: "variant"
    - path: "eval/src/eval/types.py"
      provides: "Campaign dataclass with variant_name"
      contains: "variant_name"
  key_links:
    - from: "eval/src/eval/runner/harness.py"
      to: "eval/src/eval/variants.py"
      via: "imports get_variant"
      pattern: "from eval.variants import"
    - from: "eval/src/eval/runner/db.py"
      to: "eval/src/eval/types.py"
      via: "Campaign with variant_name"
      pattern: "variant_name"
---

<objective>
Integrate variant configuration into campaign YAML and trial execution.

Purpose: Enable campaigns to specify which agent variant to use, storing variant name in database for later analysis.
Output: Campaign config accepts variant field, database stores variant_name, harness passes variant to agent.
</objective>

<execution_context>
@/Users/jrtipton/.claude/get-shit-done/workflows/execute-plan.md
@/Users/jrtipton/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/39-config-variants/39-CONTEXT.md
@.planning/phases/39-config-variants/39-RESEARCH.md
@.planning/phases/39-config-variants/39-01-SUMMARY.md
@eval/src/eval/runner/campaign.py
@eval/src/eval/runner/db.py
@eval/src/eval/runner/harness.py
@eval/src/eval/types.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add variant field to Campaign and CampaignConfig</name>
  <files>eval/src/eval/types.py, eval/src/eval/runner/campaign.py</files>
  <action>
1. Update `eval/src/eval/types.py` - add variant_name field to Campaign dataclass:

In the Campaign dataclass, add after `baseline: bool = False`:
```python
    variant_name: str = "default"
```

2. Update `eval/src/eval/runner/campaign.py` - add variant field to CampaignConfig:

Add to CampaignConfig class after `include_baseline: bool = False`:
```python
    variant: str = Field(default="default", description="Variant name to use for agent configuration")
```

Update expand_campaign_matrix function to include variant in trial specs. In the trials.append() call inside the for loop, add:
```python
"variant": config.variant,
```

And in the baseline trials section:
```python
"variant": config.variant,
```

The full updated expand_campaign_matrix should pass variant through to each trial spec.
  </action>
  <verify>
Run: `cd /Users/jrtipton/x/operator/eval && python -c "
from eval.types import Campaign
from eval.runner.campaign import CampaignConfig, expand_campaign_matrix
import yaml

# Test Campaign with variant
c = Campaign(subject_name='tikv', chaos_type='node_kill', trial_count=1, variant_name='haiku-v1')
print(f'Campaign variant: {c.variant_name}')

# Test CampaignConfig with variant
config = CampaignConfig(name='test', chaos_types=[{'type': 'node_kill'}], variant='haiku-v1')
print(f'CampaignConfig variant: {config.variant}')

# Test matrix expansion includes variant
specs = expand_campaign_matrix(config)
print(f'Trial spec variant: {specs[0][\"variant\"]}')
"`
  </verify>
  <done>Campaign and CampaignConfig have variant fields, matrix expansion passes variant to specs</done>
</task>

<task type="auto">
  <name>Task 2: Add variant_name column to database schema</name>
  <files>eval/src/eval/runner/db.py</files>
  <action>
Update the EvalDB class to support variant_name:

1. Update SCHEMA_SQL to add variant_name column (for new databases):
```sql
CREATE TABLE IF NOT EXISTS campaigns (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    subject_name TEXT NOT NULL,
    chaos_type TEXT NOT NULL,
    trial_count INTEGER NOT NULL,
    baseline INTEGER NOT NULL DEFAULT 0,
    variant_name TEXT DEFAULT 'default',
    created_at TEXT NOT NULL
);

-- Add index for variant queries
CREATE INDEX IF NOT EXISTS idx_campaigns_variant ON campaigns(variant_name);
```

2. Add migration method to EvalDB class:
```python
async def migrate_schema(self) -> None:
    """Run schema migrations for new columns.

    Safe to call multiple times - checks if columns exist before adding.
    """
    async with aiosqlite.connect(self.db_path) as db:
        # Check if variant_name column exists
        cursor = await db.execute("PRAGMA table_info(campaigns)")
        columns = await cursor.fetchall()
        column_names = [col[1] for col in columns]

        if "variant_name" not in column_names:
            await db.execute(
                "ALTER TABLE campaigns ADD COLUMN variant_name TEXT DEFAULT 'default'"
            )
            await db.execute(
                "CREATE INDEX IF NOT EXISTS idx_campaigns_variant ON campaigns(variant_name)"
            )
            await db.commit()
```

3. Update ensure_schema to call migrate_schema:
```python
async def ensure_schema(self) -> None:
    """Create tables if not exist and run migrations."""
    async with aiosqlite.connect(self.db_path) as db:
        await db.executescript(SCHEMA_SQL)
        await db.commit()
    await self.migrate_schema()
```

4. Update insert_campaign to include variant_name:
```python
async def insert_campaign(self, campaign: Campaign) -> int:
    """Insert campaign record, return campaign_id."""
    async with aiosqlite.connect(self.db_path) as db:
        cursor = await db.execute(
            """
            INSERT INTO campaigns (subject_name, chaos_type, trial_count, baseline, variant_name, created_at)
            VALUES (?, ?, ?, ?, ?, ?)
            """,
            (
                campaign.subject_name,
                campaign.chaos_type,
                campaign.trial_count,
                1 if campaign.baseline else 0,
                campaign.variant_name,
                campaign.created_at,
            ),
        )
        await db.commit()
        return cursor.lastrowid or 0
```

5. Update get_campaign and get_all_campaigns to read variant_name:

In get_campaign, add to Campaign constructor:
```python
variant_name=row["variant_name"] if "variant_name" in row.keys() else "default",
```

In get_all_campaigns, add the same to Campaign constructor.
  </action>
  <verify>
Run: `cd /Users/jrtipton/x/operator/eval && python -c "
import asyncio
from pathlib import Path
from eval.runner.db import EvalDB
from eval.types import Campaign

async def test():
    import tempfile
    with tempfile.NamedTemporaryFile(suffix='.db', delete=False) as f:
        db_path = Path(f.name)

    db = EvalDB(db_path)
    await db.ensure_schema()

    # Insert campaign with variant
    c = Campaign(subject_name='tikv', chaos_type='node_kill', trial_count=1, variant_name='haiku-v1')
    campaign_id = await db.insert_campaign(c)

    # Read it back
    campaign = await db.get_campaign(campaign_id)
    print(f'Stored variant: {campaign.variant_name}')
    assert campaign.variant_name == 'haiku-v1', 'Variant not stored correctly'

    # Test migration on existing db (should be idempotent)
    await db.migrate_schema()
    print('Migration idempotent: OK')

    import os
    os.unlink(db_path)
    print('Database test passed')

asyncio.run(test())
"`
  </verify>
  <done>Database schema includes variant_name column, migration is idempotent, CRUD operations preserve variant</done>
</task>

<task type="auto">
  <name>Task 3: Integrate variant into harness and CLI</name>
  <files>eval/src/eval/runner/harness.py, eval/src/eval/cli.py</files>
  <action>
1. Update `eval/src/eval/runner/harness.py`:

Add import at top:
```python
from eval.variants import get_variant
from eval.types import VariantConfig
```

Update run_campaign_from_config to load variant and pass to trials:

After loading trial_specs, add:
```python
# Load variant configuration
try:
    variant_config = get_variant(config.variant)
    console.print(f"[dim]Using variant: {variant_config.name} (model: {variant_config.model})[/dim]")
except ValueError as e:
    console.print(f"[red]Error loading variant: {e}[/red]")
    raise
```

Update Campaign creation to include variant:
```python
campaign = Campaign(
    subject_name=",".join(config.subjects),
    chaos_type=",".join(c.type for c in config.chaos_types),
    trial_count=total_trials,
    baseline=config.include_baseline,
    variant_name=config.variant,
    created_at=now(),
)
```

For now, variant_config is loaded but the actual agent integration is handled separately (the agent loop in operator-core would need modification to use variant config). This plan ensures the eval harness stores and tracks variants correctly.

2. Update `eval/src/eval/cli.py`:

Update run_campaign_cmd to show variant in summary output. After the line `console.print(f"Include baseline: {config.include_baseline}")`, add:
```python
console.print(f"Variant: {config.variant}")
```

Update list_campaigns to show variant if column exists. In the plain text table section, add variant column:

Change header line to:
```python
print(f"{'ID':<6} {'Date':<12} {'Subject':<10} {'Chaos':<12} {'Variant':<12} {'Trials':<8} {'Baseline':<8}")
print("-" * 70)
```

And in the loop, add variant_name handling:
```python
variant_str = getattr(c, 'variant_name', 'default')[:10]
print(f"{c.id:<6} {date_str:<12} {c.subject_name:<10} {c.chaos_type:<12} {variant_str:<12} {c.trial_count:<8} {baseline_str:<8}")
```

Also update the JSON output in list_campaigns to include variant_name:
```python
"variant_name": getattr(c, 'variant_name', 'default'),
```
  </action>
  <verify>
Run: `cd /Users/jrtipton/x/operator/eval && python -c "
# Verify imports work
from eval.runner.harness import run_campaign_from_config
from eval.variants import get_variant
print('Harness imports OK')

# Verify variant loading
v = get_variant('default')
print(f'Default variant loaded: {v.name}')
"`

Then test CLI shows variant:
`cd /Users/jrtipton/x/operator/eval && python -m eval.cli list --help`
  </verify>
  <done>Harness loads variant config, CLI shows variant in campaign summary and list output</done>
</task>

</tasks>

<verification>
1. `cd /Users/jrtipton/x/operator/eval && python -c "from eval.types import Campaign; c = Campaign(variant_name='test'); print(c.variant_name)"` - should print 'test'
2. `cd /Users/jrtipton/x/operator/eval && python -c "from eval.runner.campaign import CampaignConfig; c = CampaignConfig(name='t', chaos_types=[{'type': 'node_kill'}], variant='haiku'); print(c.variant)"` - should print 'haiku'
3. Database schema includes variant_name column
4. CLI list command shows Variant column
</verification>

<success_criteria>
- Campaign dataclass has variant_name field (default: "default")
- CampaignConfig has variant field (default: "default")
- Database schema includes variant_name with migration support
- Harness loads and logs variant configuration
- CLI displays variant in list and campaign run output
</success_criteria>

<output>
After completion, create `.planning/phases/39-config-variants/39-02-SUMMARY.md`
</output>
