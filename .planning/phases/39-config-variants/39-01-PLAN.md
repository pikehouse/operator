---
phase: 39-config-variants
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - eval/src/eval/types.py
  - eval/src/eval/variants.py
  - eval/variants/default.yaml
  - eval/src/eval/cli.py
autonomous: true

must_haves:
  truths:
    - "Developer can load a variant YAML file and get validated config"
    - "Developer can list available variants via CLI"
    - "Default variant exists with current agent configuration"
  artifacts:
    - path: "eval/src/eval/types.py"
      provides: "VariantConfig Pydantic model"
      contains: "class VariantConfig"
    - path: "eval/src/eval/variants.py"
      provides: "Variant loading and discovery functions"
      exports: ["load_variant_config", "load_all_variants", "get_variant"]
    - path: "eval/variants/default.yaml"
      provides: "Default variant with current agent config"
      contains: "name: default"
    - path: "eval/src/eval/cli.py"
      provides: "list-variants CLI command"
      contains: "def list_variants"
  key_links:
    - from: "eval/src/eval/variants.py"
      to: "eval/src/eval/types.py"
      via: "imports VariantConfig"
      pattern: "from eval.types import.*VariantConfig"
    - from: "eval/src/eval/cli.py"
      to: "eval/src/eval/variants.py"
      via: "imports variant functions"
      pattern: "from eval.variants import"
---

<objective>
Create variant configuration system with Pydantic validation and CLI listing.

Purpose: Enable declarative agent configuration variants that can be validated and discovered.
Output: VariantConfig model, variant loading module, default variant YAML, list-variants CLI command.
</objective>

<execution_context>
@/Users/jrtipton/.claude/get-shit-done/workflows/execute-plan.md
@/Users/jrtipton/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/39-config-variants/39-CONTEXT.md
@.planning/phases/39-config-variants/39-RESEARCH.md
@eval/src/eval/types.py
@eval/src/eval/cli.py
@packages/operator-core/src/operator_core/agent_lab/prompts.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add VariantConfig model to types.py</name>
  <files>eval/src/eval/types.py</files>
  <action>
Add VariantConfig Pydantic model at the end of the file after the Trial dataclass:

```python
from pydantic import BaseModel, Field
from typing import Any

class VariantConfig(BaseModel):
    """Agent configuration variant for A/B testing.

    Defines model, system prompt, and tool configuration for an agent variant.
    """
    name: str = Field(..., min_length=1, description="Human-readable variant name")
    model: str = Field(..., description="Anthropic model ID (e.g., claude-opus-4-20250514)")
    system_prompt: str = Field(..., min_length=1, description="System prompt text (inline)")
    tools_config: dict[str, Any] = Field(
        default_factory=dict,
        description="Tool configuration (tool_choice, enabled_tools)"
    )
```

Note: Do NOT add model validation - let it fail at runtime if invalid model is used. This allows testing with new models without code changes.
  </action>
  <verify>
Run: `cd /Users/jrtipton/x/operator/eval && python -c "from eval.types import VariantConfig; v = VariantConfig(name='test', model='claude-opus-4-20250514', system_prompt='You are helpful'); print(v)"`
  </verify>
  <done>VariantConfig model imports and validates successfully</done>
</task>

<task type="auto">
  <name>Task 2: Create variants module and default.yaml</name>
  <files>eval/src/eval/variants.py, eval/variants/default.yaml</files>
  <action>
Create new file `eval/src/eval/variants.py`:

```python
"""Variant configuration loading and discovery."""

from pathlib import Path
from typing import Any

import yaml

from eval.types import VariantConfig


# Default variants directory (relative to eval package root)
VARIANTS_DIR = Path(__file__).parent.parent.parent.parent / "variants"


def load_variant_config(path: Path) -> VariantConfig:
    """Load and validate variant from YAML file.

    Args:
        path: Path to variant YAML file

    Returns:
        Validated VariantConfig

    Raises:
        FileNotFoundError: If file doesn't exist
        pydantic.ValidationError: If YAML doesn't match schema
    """
    with open(path) as f:
        data = yaml.safe_load(f)
    return VariantConfig.model_validate(data)


def load_all_variants(variants_dir: Path | None = None) -> dict[str, VariantConfig]:
    """Load all variant configs from directory.

    Args:
        variants_dir: Directory containing variant YAML files.
                     Defaults to eval/variants/

    Returns:
        Dict mapping variant name to VariantConfig
    """
    if variants_dir is None:
        variants_dir = VARIANTS_DIR

    variants: dict[str, VariantConfig] = {}

    if not variants_dir.exists():
        return variants

    for yaml_file in variants_dir.glob("*.yaml"):
        try:
            variant = load_variant_config(yaml_file)
            variants[variant.name] = variant
        except Exception:
            # Skip invalid files (logged elsewhere if needed)
            pass

    return variants


def get_variant(name: str, variants_dir: Path | None = None) -> VariantConfig:
    """Get specific variant by name.

    Args:
        name: Variant name to load
        variants_dir: Directory containing variant YAML files

    Returns:
        VariantConfig for the named variant

    Raises:
        ValueError: If variant not found
    """
    if variants_dir is None:
        variants_dir = VARIANTS_DIR

    # Try direct file match first
    variant_file = variants_dir / f"{name}.yaml"
    if variant_file.exists():
        return load_variant_config(variant_file)

    # Fall back to scanning all variants
    variants = load_all_variants(variants_dir)
    if name in variants:
        return variants[name]

    available = list(variants.keys()) or ["(none found)"]
    raise ValueError(f"Variant '{name}' not found. Available: {', '.join(available)}")
```

Create directory and default variant file `eval/variants/default.yaml`:

```yaml
name: default
model: claude-opus-4-20250514
system_prompt: |
  You are an SRE operator responsible for diagnosing and fixing infrastructure issues.

  You will receive a ticket describing an issue. Your job is to investigate and resolve it.

  You have shell access to the host machine. Services run in Docker containers.

  Note: The ticket message includes the container hostname (e.g., "at tikv0:20160").

  Trust your judgment. When you've resolved the issue or determined you cannot fix it,
  clearly state your conclusion and what was done.
tools_config:
  tool_choice: auto
  enabled_tools:
    - shell
```

This default.yaml mirrors the current SYSTEM_PROMPT from operator_core/agent_lab/prompts.py.
  </action>
  <verify>
Run: `cd /Users/jrtipton/x/operator/eval && python -c "from eval.variants import load_all_variants, get_variant; variants = load_all_variants(); print(f'Found {len(variants)} variants'); v = get_variant('default'); print(f'Default variant model: {v.model}')"`
  </verify>
  <done>Variants module loads default.yaml successfully, get_variant('default') returns valid config</done>
</task>

<task type="auto">
  <name>Task 3: Add list-variants CLI command</name>
  <files>eval/src/eval/cli.py</files>
  <action>
Add a new CLI command `list-variants` to cli.py. Add import and command:

1. Add import near top with other imports:
```python
from eval.variants import load_all_variants
```

2. Add command before the `main()` function:
```python
@app.command("list-variants")
def list_variants_cmd(
    variants_dir: Optional[Path] = typer.Option(
        None,
        "--dir",
        help="Path to variants directory (default: eval/variants/)",
    ),
    json_output: bool = typer.Option(False, "--json", help="Output as JSON"),
) -> None:
    """List available agent configuration variants.

    Shows all variants found in the variants directory with their model and
    system prompt preview.

    Examples:
        eval list-variants
        eval list-variants --json
        eval list-variants --dir ./my-variants/
    """
    variants = load_all_variants(variants_dir)

    if not variants:
        console.print("[yellow]No variants found[/yellow]")
        if variants_dir:
            console.print(f"Directory: {variants_dir}")
        else:
            console.print("Default directory: eval/variants/")
        return

    if json_output:
        data = [
            {
                "name": v.name,
                "model": v.model,
                "system_prompt_preview": v.system_prompt[:100] + "..." if len(v.system_prompt) > 100 else v.system_prompt,
                "tools_config": v.tools_config,
            }
            for v in variants.values()
        ]
        print(json.dumps(data, indent=2))
        return

    # Plain text table
    table = Table(title="Available Variants")
    table.add_column("Name", style="cyan")
    table.add_column("Model")
    table.add_column("System Prompt Preview")
    table.add_column("Tools")

    for v in sorted(variants.values(), key=lambda x: x.name):
        prompt_preview = v.system_prompt.split('\n')[0][:50]
        if len(v.system_prompt) > 50 or '\n' in v.system_prompt:
            prompt_preview += "..."
        tools = ", ".join(v.tools_config.get("enabled_tools", ["(default)"])[:3])
        table.add_row(v.name, v.model, prompt_preview, tools)

    console.print(table)
    console.print(f"\n{len(variants)} variant(s) found")
```
  </action>
  <verify>
Run: `cd /Users/jrtipton/x/operator/eval && python -m eval.cli list-variants`

Expected: Table showing "default" variant with model, prompt preview, and tools
  </verify>
  <done>list-variants command shows default variant in formatted table</done>
</task>

</tasks>

<verification>
1. `cd /Users/jrtipton/x/operator/eval && python -c "from eval.types import VariantConfig; print('VariantConfig OK')"`
2. `cd /Users/jrtipton/x/operator/eval && python -c "from eval.variants import load_all_variants; print(f'Variants: {list(load_all_variants().keys())}')"` - should show ['default']
3. `cd /Users/jrtipton/x/operator/eval && python -m eval.cli list-variants` - should display table with default variant
4. `cd /Users/jrtipton/x/operator/eval && python -m eval.cli list-variants --json` - should output JSON array
</verification>

<success_criteria>
- VariantConfig Pydantic model exists in types.py
- eval/variants/default.yaml exists with current agent config
- load_variant_config, load_all_variants, get_variant functions work
- list-variants CLI command displays available variants
</success_criteria>

<output>
After completion, create `.planning/phases/39-config-variants/39-01-SUMMARY.md`
</output>
