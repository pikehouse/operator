---
phase: 35-runner-layer
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - eval/pyproject.toml
  - eval/src/eval/__init__.py
  - eval/src/eval/types.py
autonomous: true

must_haves:
  truths:
    - "EvalSubject protocol is importable and type-checkable"
    - "Campaign and Trial dataclasses are JSON-serializable"
    - "eval package installs with uv pip install -e ."
  artifacts:
    - path: "eval/pyproject.toml"
      provides: "Package definition with dependencies"
      contains: "aiosqlite"
    - path: "eval/src/eval/__init__.py"
      provides: "Package exports"
      exports: ["EvalSubject", "Campaign", "Trial", "ChaosType"]
    - path: "eval/src/eval/types.py"
      provides: "Protocol and dataclass definitions"
      contains: "@runtime_checkable"
  key_links:
    - from: "eval/src/eval/__init__.py"
      to: "eval/src/eval/types.py"
      via: "re-exports"
      pattern: "from eval.types import"
---

<objective>
Create the eval package foundation with EvalSubject protocol and core data types.

Purpose: Establish the type contracts that all eval components will implement — the EvalSubject protocol for subject abstraction and Campaign/Trial dataclasses for data persistence.

Output: Installable eval/ package with types.py defining EvalSubject protocol and data models.
</objective>

<execution_context>
@/Users/jrtipton/.claude/get-shit-done/workflows/execute-plan.md
@/Users/jrtipton/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/35-runner-layer/35-RESEARCH.md

# Reference for existing package patterns
@packages/operator-core/pyproject.toml
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create eval package structure</name>
  <files>
    eval/pyproject.toml
    eval/src/eval/__init__.py
  </files>
  <action>
Create eval package following existing operator-core patterns:

1. Create `eval/pyproject.toml`:
   - name: "eval"
   - version: "0.1.0"
   - requires-python: ">=3.11"
   - dependencies: aiosqlite>=0.20.0, python-on-whales>=0.70.0, typer>=0.21.0, rich>=14.0.0, pydantic>=2.0.0, httpx>=0.27.0
   - scripts entry: eval = "eval.cli:main"
   - build-system: hatchling
   - hatch.build.targets.wheel packages: ["src/eval"]

2. Create `eval/src/eval/__init__.py`:
   - Import and re-export from types.py (will be created in Task 2)
   - Export: EvalSubject, Campaign, Trial, ChaosType
   - __version__ = "0.1.0"

Directory structure to create:
```
eval/
├── pyproject.toml
└── src/
    └── eval/
        └── __init__.py
```
  </action>
  <verify>
Run: `ls -la eval/ && cat eval/pyproject.toml`
Confirm pyproject.toml has correct dependencies and scripts entry.
  </verify>
  <done>eval/ directory exists with pyproject.toml containing aiosqlite, python-on-whales, typer dependencies and "eval" CLI script entry</done>
</task>

<task type="auto">
  <name>Task 2: Define EvalSubject protocol and data types</name>
  <files>
    eval/src/eval/types.py
  </files>
  <action>
Create types.py with Protocol and dataclasses based on RESEARCH.md patterns:

1. **EvalSubject Protocol** (SUBJ-01):
```python
from typing import Protocol, Any, runtime_checkable

@runtime_checkable
class EvalSubject(Protocol):
    """Protocol for evaluation subjects."""

    async def reset(self) -> None:
        """Reset subject to clean initial state."""
        ...

    async def wait_healthy(self, timeout_sec: float = 60.0) -> bool:
        """Wait for subject to reach healthy state."""
        ...

    async def capture_state(self) -> dict[str, Any]:
        """Capture current subject state for comparison."""
        ...

    def get_chaos_types(self) -> list[str]:
        """Return list of chaos types this subject supports."""
        ...

    async def inject_chaos(self, chaos_type: str) -> dict[str, Any]:
        """Inject specified chaos type, return metadata."""
        ...
```

2. **ChaosType enum** for type safety:
```python
from enum import Enum

class ChaosType(str, Enum):
    NODE_KILL = "node_kill"
    # Future: LATENCY, DISK_PRESSURE, NETWORK_PARTITION
```

3. **Campaign dataclass** (RUN-06):
```python
from dataclasses import dataclass, field
from datetime import datetime, timezone

@dataclass
class Campaign:
    id: int | None = None
    subject_name: str = ""
    chaos_type: str = ""
    trial_count: int = 0
    baseline: bool = False
    created_at: str = field(default_factory=lambda: datetime.now(timezone.utc).isoformat())
```

4. **Trial dataclass** (RUN-02, RUN-03, RUN-04):
```python
@dataclass
class Trial:
    id: int | None = None
    campaign_id: int = 0
    started_at: str = ""
    chaos_injected_at: str = ""
    ticket_created_at: str | None = None  # None for baseline
    resolved_at: str | None = None        # None if not resolved
    ended_at: str = ""
    initial_state: str = ""               # JSON blob
    final_state: str = ""                 # JSON blob
    chaos_metadata: str = ""              # JSON blob
    commands_json: str = "[]"             # JSON array of commands (RUN-04)
```

Use `datetime.now(timezone.utc).isoformat()` for all timestamps per RESEARCH.md.
  </action>
  <verify>
Run: `cd eval && uv pip install -e . && uv run python -c "from eval import EvalSubject, Campaign, Trial, ChaosType; print('Types imported successfully')"`
  </verify>
  <done>EvalSubject protocol is @runtime_checkable, Campaign and Trial dataclasses exist with all timing fields, package installs cleanly</done>
</task>

<task type="auto">
  <name>Task 3: Update eval __init__.py exports</name>
  <files>
    eval/src/eval/__init__.py
  </files>
  <action>
Update __init__.py to properly export all types:

```python
"""Evaluation harness for chaos engineering trials."""

from eval.types import (
    EvalSubject,
    ChaosType,
    Campaign,
    Trial,
)

__version__ = "0.1.0"

__all__ = [
    "EvalSubject",
    "ChaosType",
    "Campaign",
    "Trial",
]
```

Verify the circular import is avoided (types.py has no imports from eval package).
  </action>
  <verify>
Run: `cd eval && uv run python -c "from eval import EvalSubject, Campaign, Trial; from eval.types import EvalSubject as ES; print(EvalSubject is ES)"`
Should print "True" confirming re-export works.
  </verify>
  <done>eval package exports EvalSubject, Campaign, Trial, ChaosType from top-level __init__.py</done>
</task>

</tasks>

<verification>
After all tasks complete:
1. `ls -la eval/src/eval/` shows __init__.py and types.py
2. `uv pip install -e eval/` succeeds
3. `uv run python -c "from eval import EvalSubject; print(EvalSubject)"` shows Protocol class
4. `uv run python -c "from eval import Trial; t = Trial(); import json; print(json.dumps({'started_at': t.started_at}))"` succeeds (JSON serializable)
</verification>

<success_criteria>
- [ ] eval/pyproject.toml exists with correct dependencies
- [ ] eval/src/eval/__init__.py exports EvalSubject, Campaign, Trial, ChaosType
- [ ] eval/src/eval/types.py contains @runtime_checkable EvalSubject Protocol
- [ ] Campaign dataclass has: id, subject_name, chaos_type, trial_count, baseline, created_at
- [ ] Trial dataclass has: id, campaign_id, started_at, chaos_injected_at, ticket_created_at, resolved_at, ended_at, initial_state, final_state, chaos_metadata, commands_json
- [ ] Package installs with uv pip install -e .
</success_criteria>

<output>
After completion, create `.planning/phases/35-runner-layer/35-01-SUMMARY.md`
</output>
