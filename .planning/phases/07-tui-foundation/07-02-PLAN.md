---
phase: 07-tui-foundation
plan: 02
type: execute
wave: 2
depends_on: ["07-01"]
files_modified:
  - packages/operator-core/src/operator_core/tui/controller.py
  - packages/operator-core/src/operator_core/tui/__init__.py
autonomous: false

must_haves:
  truths:
    - "TUI displays all 5 panels simultaneously"
    - "Layout renders without flicker using Rich Live context"
    - "Ctrl+C cleanly exits without corrupted terminal state"
    - "Signal handlers restore terminal before exit"
  artifacts:
    - path: "packages/operator-core/src/operator_core/tui/controller.py"
      provides: "TUI lifecycle management with signal handling"
      contains: "class TUIController"
      min_lines: 80
    - path: "packages/operator-core/src/operator_core/tui/__init__.py"
      provides: "Complete TUI module exports"
      exports: ["OutputBuffer", "create_layout", "make_panel", "TUIController"]
  key_links:
    - from: "controller.py"
      to: "layout.py"
      via: "create_layout() call"
      pattern: "create_layout\\(\\)"
    - from: "controller.py"
      to: "rich.live.Live"
      via: "Live context manager"
      pattern: "with Live\\("
    - from: "controller.py"
      to: "asyncio signal handlers"
      via: "loop.add_signal_handler"
      pattern: "add_signal_handler"
---

<objective>
Create TUIController with signal-safe lifecycle management and verify TUI displays correctly.

Purpose: Implements the main TUI controller that coordinates async tasks, handles signals for clean shutdown, and uses Rich Live for flicker-free rendering. This completes Phase 7's foundation for the multi-panel TUI.

Output:
- `tui/controller.py` with TUIController class
- Updated `tui/__init__.py` with TUIController export
- Verified working TUI that exits cleanly on Ctrl+C
</objective>

<execution_context>
@/Users/jrtipton/.claude/get-shit-done/workflows/execute-plan.md
@/Users/jrtipton/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/07-tui-foundation/07-RESEARCH.md
@.planning/phases/07-tui-foundation/07-01-SUMMARY.md

# Pattern to follow for signal handling
@packages/operator-core/src/operator_core/monitor/loop.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create TUIController with signal handling</name>
  <files>
    packages/operator-core/src/operator_core/tui/controller.py
    packages/operator-core/src/operator_core/tui/__init__.py
  </files>
  <action>
Create TUIController per RESEARCH.md Pattern 4 (Live Context with Signal Handlers):

1. Create `tui/controller.py`:

```python
class TUIController:
    """Controls TUI lifecycle with proper signal handling."""
```

**Constructor `__init__(self, console: Console | None = None)`:**
- Accept optional Console (create default if None)
- Initialize `self._shutdown = asyncio.Event()`
- Initialize `self._layout = create_layout()`
- Store console reference

**Method `async def run(self) -> None`:**

CRITICAL ORDER (per RESEARCH.md Pitfall 2):
1. Get running loop: `loop = asyncio.get_running_loop()`
2. Register signal handlers BEFORE Live context:
   ```python
   for sig in (signal.SIGINT, signal.SIGTERM):
       loop.add_signal_handler(
           sig,
           functools.partial(self._handle_signal, sig),
       )
   ```
3. Initialize panels with placeholder content using make_panel()
4. Enter Live context:
   ```python
   with Live(
       self._layout,
       console=self.console,
       refresh_per_second=4,
       screen=False,  # Don't use alternate screen for demo
   ) as live:
   ```
5. Inside Live context, use wait_for with timeout (RESEARCH.md Pattern):
   ```python
   while not self._shutdown.is_set():
       self._refresh_panels()
       live.refresh()
       try:
           await asyncio.wait_for(self._shutdown.wait(), timeout=0.25)
       except asyncio.TimeoutError:
           pass
   ```
6. After Live context exits, print shutdown message

**Method `def _handle_signal(self, sig: signal.Signals) -> None`:**
- Print signal name (use self.console.print if Live is active, but signal handler runs outside - so just set the event)
- Set `self._shutdown.set()`

**Method `def _refresh_panels(self) -> None`:**
- For now, just update panels with static placeholder text
- This will be extended in later phases to show real content
- Update each panel: cluster, narration, monitor, agent, workload

**Method `def update_panel(self, name: str, content: str, title: str, style: str = "blue") -> None`:**
- Public method to update a specific panel's content
- Uses make_panel() to create the panel
- Updates layout[name] if name is "cluster", otherwise layout["main"][name]

2. Update `tui/__init__.py`:
- Add TUIController to imports and __all__

Imports needed in controller.py:
- asyncio, functools, signal (stdlib)
- Console, Live from rich
- create_layout, make_panel from .layout

DO NOT use asyncio.TaskGroup yet - that's for Phase 8 subprocess coordination. This phase uses simple while loop with Event.wait().
  </action>
  <verify>
Run: `cd /Users/jrtipton/x/operator && python -c "from operator_core.tui import TUIController; print('TUIController import OK')"`

Expected: `TUIController import OK`
  </verify>
  <done>
TUIController class exists with run(), _handle_signal(), _refresh_panels(), update_panel() methods. Signal handlers registered before Live context. Export available from operator_core.tui.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 2: Verify TUI displays and exits cleanly</name>
  <what-built>
TUI foundation with 5-panel layout, signal handling, and clean shutdown. The TUI should display 5 panels with placeholder content and exit cleanly on Ctrl+C.
  </what-built>
  <how-to-verify>
1. Create a test script and run it:

```bash
cd /Users/jrtipton/x/operator
cat > /tmp/test_tui.py << 'EOF'
import asyncio
from operator_core.tui import TUIController

async def main():
    controller = TUIController()
    await controller.run()

if __name__ == "__main__":
    asyncio.run(main())
EOF
python /tmp/test_tui.py
```

2. Verify these behaviors:
   - [ ] TUI displays 5 panels: Cluster Status (left), Narration (top-right), Monitor (middle-right), Agent (middle-right), Workload (bottom-right)
   - [ ] Layout renders without visible flicker (smooth 4fps refresh)
   - [ ] Press Ctrl+C
   - [ ] TUI exits with shutdown message
   - [ ] Terminal is NOT corrupted (prompt displays correctly, typing works)
   - [ ] Run `echo "terminal ok"` to confirm terminal state

3. Test rapid Ctrl+C (edge case per RESEARCH.md Pitfall 1):
   - Run the script again
   - Press Ctrl+C immediately (within 1 second of startup)
   - Terminal should still be clean
  </how-to-verify>
  <resume-signal>Type "approved" if all checks pass, or describe any issues with terminal corruption, missing panels, or unclean shutdown.</resume-signal>
</task>

</tasks>

<verification>
Phase 7 success criteria verification:

1. **TUI displays 5 distinct panels:**
```bash
cd /Users/jrtipton/x/operator && python -c "
from operator_core.tui import create_layout
layout = create_layout()
panels = ['cluster']
panels.extend(['narration', 'monitor', 'agent', 'workload'])  # in main
print(f'Panel count: {len(panels)}')
assert len(panels) == 5, 'Should have 5 panels'
print('5 panels verified')
"
```

2. **Signal handlers registered:** Code inspection confirms handlers registered BEFORE Live context

3. **Clean imports:**
```bash
cd /Users/jrtipton/x/operator && python -c "
from operator_core.tui import OutputBuffer, create_layout, make_panel, TUIController
print('All TUI exports available')
"
```
</verification>

<success_criteria>
- [ ] TUIController class implements run() with proper signal handling
- [ ] Signal handlers registered BEFORE entering Live context
- [ ] Live context used with refresh_per_second=4, screen=False
- [ ] Ctrl+C triggers clean shutdown (no terminal corruption)
- [ ] All 5 panels display with placeholder content
- [ ] TUIController exported from operator_core.tui
- [ ] Human verification confirms visual and behavioral correctness
</success_criteria>

<output>
After completion, create `.planning/phases/07-tui-foundation/07-02-SUMMARY.md`
</output>
