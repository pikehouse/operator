---
phase: 13-tikv-subject-actions
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - packages/operator-tikv/src/operator_tikv/pd_client.py
  - packages/operator-tikv/src/operator_tikv/subject.py
autonomous: true
user_setup: []

must_haves:
  truths:
    - "Agent can execute transfer-leader action that moves region leader to specified store"
    - "Agent can execute transfer-peer action that moves region replica to different store"
    - "Agent can execute drain-store action that evicts all leaders from a store"
    - "TiKVSubject.get_action_definitions() returns ActionDefinition objects for all three actions"
  artifacts:
    - path: "packages/operator-tikv/src/operator_tikv/pd_client.py"
      provides: "PD API POST methods for operators and schedulers"
      contains: "add_transfer_leader_operator"
    - path: "packages/operator-tikv/src/operator_tikv/subject.py"
      provides: "Implemented action methods and get_action_definitions"
      contains: "def get_action_definitions"
  key_links:
    - from: "TiKVSubject.transfer_leader"
      to: "PDClient.add_transfer_leader_operator"
      via: "await self.pd.add_transfer_leader_operator()"
      pattern: "self\\.pd\\.add_transfer_leader_operator"
    - from: "TiKVSubject.transfer_peer"
      to: "PDClient.add_transfer_peer_operator"
      via: "await self.pd.add_transfer_peer_operator()"
      pattern: "self\\.pd\\.add_transfer_peer_operator"
    - from: "TiKVSubject.drain_store"
      to: "PDClient.add_evict_leader_scheduler"
      via: "await self.pd.add_evict_leader_scheduler()"
      pattern: "self\\.pd\\.add_evict_leader_scheduler"
---

<objective>
Implement TiKV subject action execution via PD API

Purpose: Enable agent to execute remediation actions (leader transfer, peer transfer, store drain) through TiKV subject, completing the action execution layer for v2.0.

Output: TiKVSubject with working action methods that call PD API, plus get_action_definitions() for Phase 12 action registry integration.
</objective>

<execution_context>
@/Users/jrtipton/.claude/get-shit-done/workflows/execute-plan.md
@/Users/jrtipton/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Phase 12 action foundation (action types, registry, executor)
@.planning/phases/12-action-foundation/12-02-SUMMARY.md

# Research provides PD API patterns and exact POST body formats
@.planning/phases/13-tikv-subject-actions/13-RESEARCH.md

# CONTEXT.md decisions: fire-and-forget, minimal validation, pass-through errors
@.planning/phases/13-tikv-subject-actions/13-CONTEXT.md

# Current implementations
@packages/operator-tikv/src/operator_tikv/pd_client.py
@packages/operator-tikv/src/operator_tikv/subject.py
@packages/operator-core/src/operator_core/actions/registry.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add PD API operator and scheduler methods to PDClient</name>
  <files>packages/operator-tikv/src/operator_tikv/pd_client.py</files>
  <action>
Add three async methods to PDClient for PD API POST operations:

1. `add_transfer_leader_operator(region_id: int, to_store_id: int) -> None`
   - POST to `/pd/api/v1/operators`
   - JSON body: `{"name": "transfer-leader", "region_id": <int>, "store_id": <int>}`
   - Call `response.raise_for_status()` to propagate errors

2. `add_transfer_peer_operator(region_id: int, from_store_id: int, to_store_id: int) -> None`
   - POST to `/pd/api/v1/operators`
   - JSON body: `{"name": "transfer-peer", "region_id": <int>, "from_store_id": <int>, "to_store_id": <int>}`
   - Call `response.raise_for_status()` to propagate errors

3. `add_evict_leader_scheduler(store_id: int) -> None`
   - POST to `/pd/api/v1/schedulers`
   - JSON body: `{"name": "evict-leader-scheduler", "store_id": <int>}`
   - Call `response.raise_for_status()` to propagate errors

IMPORTANT:
- Use hyphens in operator/scheduler names ("transfer-leader", not "transfer_leader")
- All store_id parameters are integers for PD API (conversion happens in Subject)
- Follow existing method docstring style (see get_stores, get_regions)
- Fire-and-forget: no response parsing needed, just raise on errors
  </action>
  <verify>
Run `python -c "from operator_tikv.pd_client import PDClient; import inspect; print([m for m in dir(PDClient) if 'add_' in m])"` shows all three new methods.
  </verify>
  <done>
PDClient has add_transfer_leader_operator, add_transfer_peer_operator, and add_evict_leader_scheduler methods that POST to PD API endpoints.
  </done>
</task>

<task type="auto">
  <name>Task 2: Implement TiKVSubject action methods</name>
  <files>packages/operator-tikv/src/operator_tikv/subject.py</files>
  <action>
Replace the NotImplementedError stubs with real implementations that delegate to PDClient:

1. `transfer_leader(region_id: int, to_store_id: str) -> None`
   - Convert to_store_id to int: `await self.pd.add_transfer_leader_operator(region_id, int(to_store_id))`
   - Update docstring: remove "deferred to Phase 5", add fire-and-forget semantics

2. `drain_store(store_id: str) -> None`
   - Convert store_id to int: `await self.pd.add_evict_leader_scheduler(int(store_id))`
   - Update docstring: remove "deferred to Phase 5", document that this is a persistent scheduler

3. Add new method `transfer_peer(region_id: int, from_store_id: str, to_store_id: str) -> None`
   - Convert store IDs to int: `await self.pd.add_transfer_peer_operator(region_id, int(from_store_id), int(to_store_id))`
   - Add docstring describing peer transfer (move replica between stores)

4. Add transfer_peer to TIKV_CONFIG.actions list:
   ```python
   Action(
       "transfer_peer",
       ["region_id", "from_store_id", "to_store_id"],
       description="Move region replica from one store to another",
   ),
   ```

IMPORTANT:
- Store IDs come as strings from operator-core, convert to int for PD API
- Keep other stub methods (split_region, set_*) raising NotImplementedError - out of scope
- Keep existing observations section unchanged
  </action>
  <verify>
Run `python -c "from operator_tikv.subject import TiKVSubject; s = TiKVSubject.__new__(TiKVSubject); print('transfer_leader' in dir(s) and 'transfer_peer' in dir(s) and 'drain_store' in dir(s))"` returns True.
  </verify>
  <done>
TiKVSubject.transfer_leader, transfer_peer, and drain_store delegate to PDClient methods with proper type conversion.
  </done>
</task>

<task type="auto">
  <name>Task 3: Implement get_action_definitions for ActionRegistry integration</name>
  <files>packages/operator-tikv/src/operator_tikv/subject.py</files>
  <action>
Add get_action_definitions() method to TiKVSubject for Phase 12 ActionRegistry integration:

1. Add import at top of file:
   ```python
   from operator_core.actions.registry import ActionDefinition, ParamDef
   ```

2. Add method to TiKVSubject class:
   ```python
   def get_action_definitions(self) -> list[ActionDefinition]:
       """
       Return definitions of all actions this subject supports.

       Used by ActionRegistry to discover available actions at runtime.
       """
       return [
           ActionDefinition(
               name="transfer_leader",
               description="Transfer region leadership to another store",
               parameters={
                   "region_id": ParamDef(
                       type="int",
                       description="ID of the region to transfer",
                       required=True,
                   ),
                   "to_store_id": ParamDef(
                       type="str",
                       description="Target store ID for leadership",
                       required=True,
                   ),
               },
               risk_level="medium",
               requires_approval=False,
           ),
           ActionDefinition(
               name="transfer_peer",
               description="Move region replica from one store to another",
               parameters={
                   "region_id": ParamDef(
                       type="int",
                       description="ID of the region to move",
                       required=True,
                   ),
                   "from_store_id": ParamDef(
                       type="str",
                       description="Source store ID holding the replica",
                       required=True,
                   ),
                   "to_store_id": ParamDef(
                       type="str",
                       description="Target store ID for the replica",
                       required=True,
                   ),
               },
               risk_level="high",
               requires_approval=False,
           ),
           ActionDefinition(
               name="drain_store",
               description="Evict all leaders from a store (continuous until removed)",
               parameters={
                   "store_id": ParamDef(
                       type="str",
                       description="Store ID to drain leaders from",
                       required=True,
                   ),
               },
               risk_level="high",
               requires_approval=False,
           ),
       ]
   ```

IMPORTANT:
- Parameter types match method signatures: region_id is "int", store IDs are "str"
- risk_level reflects operation impact: transfer_leader is medium, peer/drain are high
- requires_approval=False per APR-01 (default autonomous, approval configured separately)
  </action>
  <verify>
Run `python -c "from operator_tikv.subject import TiKVSubject; s = TiKVSubject.__new__(TiKVSubject); defs = s.get_action_definitions(); print(f'{len(defs)} actions:', [d.name for d in defs])"` shows 3 actions with correct names.
  </verify>
  <done>
TiKVSubject.get_action_definitions() returns ActionDefinition objects for transfer_leader, transfer_peer, and drain_store with proper parameter schemas.
  </done>
</task>

</tasks>

<verification>
Phase-level verification:

1. **Import test:**
   ```bash
   cd packages/operator-tikv && python -c "
   from operator_tikv.subject import TiKVSubject
   from operator_tikv.pd_client import PDClient
   from operator_core.actions.registry import ActionRegistry
   print('All imports successful')
   "
   ```

2. **ActionRegistry integration:**
   ```bash
   cd packages/operator-tikv && python -c "
   from operator_tikv.subject import TiKVSubject
   from operator_core.actions.registry import ActionRegistry
   import httpx

   # Create mock subject (can't actually call without PD)
   class MockPD:
       pass
   class MockProm:
       pass
   s = TiKVSubject(pd=MockPD(), prom=MockProm())

   # Test registry integration
   registry = ActionRegistry(s)
   actions = registry.list_action_names()
   print(f'Registered actions: {actions}')
   assert 'transfer_leader' in actions
   assert 'transfer_peer' in actions
   assert 'drain_store' in actions
   print('ActionRegistry integration verified')
   "
   ```

3. **Ruff lint check:**
   ```bash
   cd packages/operator-tikv && ruff check src/operator_tikv/pd_client.py src/operator_tikv/subject.py
   ```
</verification>

<success_criteria>
1. PDClient has three new async POST methods for PD API operators/schedulers
2. TiKVSubject.transfer_leader, transfer_peer, drain_store delegate to PDClient (no more NotImplementedError)
3. TiKVSubject.get_action_definitions() returns ActionDefinition list with all three actions
4. ActionRegistry successfully discovers actions from TiKVSubject
5. All code passes ruff lint checks
</success_criteria>

<output>
After completion, create `.planning/phases/13-tikv-subject-actions/13-01-SUMMARY.md`
</output>
