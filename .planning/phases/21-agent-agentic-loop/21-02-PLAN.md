---
phase: 21-agent-agentic-loop
plan: 02
type: execute
wave: 2
depends_on: ["21-01"]
files_modified:
  - demo/tui_integration.py
  - packages/operator-core/src/operator_core/cli/main.py
autonomous: true

must_haves:
  truths:
    - "Agent subprocess runs with EXECUTE mode enabled"
    - "Agent subprocess has executor with approval_mode=False"
    - "Demo shows complete agentic loop in agent panel"
  artifacts:
    - path: "demo/tui_integration.py"
      provides: "Agent subprocess with EXECUTE mode"
      contains: "OPERATOR_SAFETY_MODE"
    - path: "packages/operator-core/src/operator_core/cli/main.py"
      provides: "CLI honors safety mode env var"
      contains: "SafetyMode.EXECUTE"
  key_links:
    - from: "TUIDemoController._subprocess_mgr.spawn"
      to: "agent subprocess"
      via: "environment variables"
      pattern: "OPERATOR_SAFETY_MODE.*execute"
    - from: "agent CLI start command"
      to: "ActionExecutor"
      via: "executor creation"
      pattern: "approval_mode.*False"
---

<objective>
Configure demo to spawn agent subprocess in EXECUTE mode with autonomous execution (no approval).

Purpose: Enable the agentic loop in demos by configuring the agent subprocess with EXECUTE mode and approval_mode=False.

Output: Demo spawns agent that can execute actions autonomously and show complete loop in agent panel.
</objective>

<execution_context>
@/Users/jrtipton/.claude/get-shit-done/workflows/execute-plan.md
@/Users/jrtipton/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/21-agent-agentic-loop/21-RESEARCH.md
@.planning/phases/21-agent-agentic-loop/21-01-SUMMARY.md

@demo/tui_integration.py
@packages/operator-core/src/operator_core/cli/main.py
@packages/operator-core/src/operator_core/actions/executor.py
@packages/operator-core/src/operator_core/actions/safety.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add environment variables to agent subprocess spawn</name>
  <files>demo/tui_integration.py</files>
  <action>
Modify TUIDemoController to spawn agent subprocess with environment variables that enable EXECUTE mode and disable approval.

Current behavior: Agent subprocess spawned without environment overrides (defaults to OBSERVE mode).
New behavior: Agent subprocess spawned with OPERATOR_SAFETY_MODE=execute and OPERATOR_APPROVAL_MODE=false.

Implementation:
1. In `run()` method, when spawning agent subprocess, add environment variables.

2. The SubprocessManager.spawn() method needs to accept environment variables. Check if it already supports this. If not, add `env` parameter.

3. Pass environment to agent subprocess:
```python
agent_proc = await self._subprocess_mgr.spawn(
    "agent",
    [
        "-u",  # Unbuffered output
        "-m",
        "operator_core.cli.main",
        "agent",
        "start",
        "--subject",
        self.subject_name,
        "-i",
        "5",
    ],
    buffer_size=50,
    env={
        "OPERATOR_SAFETY_MODE": "execute",
        "OPERATOR_APPROVAL_MODE": "false",
    },
)
```

4. If SubprocessManager.spawn() doesn't support env parameter, update it in subprocess.py to merge env with current environment (os.environ).

Do NOT:
- Change monitor subprocess (monitor doesn't need execution mode)
- Hardcode safety mode in AgentRunner (should come from CLI/env)
- Remove existing subprocess options
  </action>
  <verify>
Read tui_integration.py and confirm:
- Agent subprocess spawn includes environment variables
- OPERATOR_SAFETY_MODE=execute is passed
- OPERATOR_APPROVAL_MODE=false is passed
  </verify>
  <done>
Demo spawns agent subprocess with EXECUTE mode environment variables.
  </done>
</task>

<task type="auto">
  <name>Task 2: Update CLI to honor safety mode environment variable</name>
  <files>packages/operator-core/src/operator_core/cli/main.py</files>
  <action>
Update the `agent start` CLI command to read OPERATOR_SAFETY_MODE environment variable and configure executor accordingly.

Current behavior: Agent CLI creates AgentRunner but may not properly configure executor with safety mode from environment.
New behavior: Agent CLI reads OPERATOR_SAFETY_MODE env var and creates executor with correct SafetyMode.

Implementation:
1. In the agent start command, check for OPERATOR_SAFETY_MODE env var:
```python
import os
safety_mode_str = os.environ.get("OPERATOR_SAFETY_MODE", "observe")
if safety_mode_str.lower() == "execute":
    safety_mode = SafetyMode.EXECUTE
else:
    safety_mode = SafetyMode.OBSERVE
```

2. Create SafetyController with this mode:
```python
from operator_core.actions.safety import SafetyController, SafetyMode
safety = SafetyController(db_path, auditor, mode=safety_mode)
```

3. Create ActionExecutor (if not already done):
```python
from operator_core.actions.executor import ActionExecutor
from operator_core.actions.registry import ActionRegistry
from operator_core.actions.audit import ActionAuditor

# approval_mode=False is default when OPERATOR_APPROVAL_MODE env not "true"
executor = ActionExecutor(
    db_path=db_path,
    registry=registry,
    safety=safety,
    auditor=auditor,
    # approval_mode defaults to False from env
)
```

4. Pass executor to AgentRunner:
```python
runner = AgentRunner(
    subject=subject,
    db_path=db_path,
    poll_interval=interval,
    executor=executor,  # Enable action execution
)
```

5. Log the mode for visibility:
```python
print(f"Agent starting in {safety_mode.value.upper()} mode (approval_mode={executor._approval_mode})")
```

Note: The agent CLI may already create an executor. If so, ensure it respects OPERATOR_SAFETY_MODE env var for the SafetyController.

Do NOT:
- Remove observe-only mode option (should still work when env not set)
- Change ActionExecutor defaults (approval_mode logic is already correct)
- Add CLI flags for safety mode (use environment per research recommendation)
  </action>
  <verify>
Read main.py (agent start command) and confirm:
- Reads OPERATOR_SAFETY_MODE from environment
- Creates SafetyController with correct mode
- Creates ActionExecutor and passes to AgentRunner
- Logs the mode at startup
  </verify>
  <done>
Agent CLI honors OPERATOR_SAFETY_MODE environment variable and creates executor with correct mode (DEMO-01).
  </done>
</task>

<task type="auto">
  <name>Task 3: Update SubprocessManager to support environment variables</name>
  <files>packages/operator-core/src/operator_core/tui/subprocess.py</files>
  <action>
Update SubprocessManager.spawn() to accept optional environment variables.

Implementation:
1. Add `env` parameter to spawn() method signature:
```python
async def spawn(
    self,
    name: str,
    args: list[str],
    buffer_size: int = 100,
    env: dict[str, str] | None = None,
) -> asyncio.subprocess.Process:
```

2. Merge provided env with current environment:
```python
import os

# Merge with current environment (preserve PATH, etc.)
subprocess_env = os.environ.copy()
if env:
    subprocess_env.update(env)
```

3. Pass to asyncio.create_subprocess_exec:
```python
proc = await asyncio.create_subprocess_exec(
    sys.executable,
    *args,
    stdout=asyncio.subprocess.PIPE,
    stderr=asyncio.subprocess.STDOUT,
    env=subprocess_env,  # Use merged environment
)
```

Do NOT:
- Replace entire environment (must preserve PATH, HOME, etc.)
- Change signature of existing methods that don't need env
- Add env to read_output or other methods
  </action>
  <verify>
Read subprocess.py and confirm:
- spawn() method accepts `env` parameter
- Environment is merged with os.environ.copy()
- Merged env passed to create_subprocess_exec
  </verify>
  <done>
SubprocessManager.spawn() supports environment variable overrides.
  </done>
</task>

</tasks>

<verification>
1. Read all modified files and verify changes:
   - tui_integration.py passes env to agent spawn
   - main.py agent command reads OPERATOR_SAFETY_MODE
   - subprocess.py spawn() accepts env parameter

2. Run the demo to verify agent starts in EXECUTE mode:
   ```bash
   cd /Users/jrtipton/x/operator
   # Start docker compose for one subject
   docker compose -f subjects/ratelimiter/docker-compose.yaml up -d
   # Run demo (briefly) to see agent startup message
   timeout 10 ./scripts/run-demo.sh ratelimiter || true
   docker compose -f subjects/ratelimiter/docker-compose.yaml down
   ```
   Agent panel should show "Agent starting in EXECUTE mode"
</verification>

<success_criteria>
- Demo spawns agent subprocess with OPERATOR_SAFETY_MODE=execute
- Agent CLI reads environment and creates executor with EXECUTE mode
- Agent startup message shows "EXECUTE mode"
- Requirements covered: DEMO-01
</success_criteria>

<output>
After completion, create `.planning/phases/21-agent-agentic-loop/21-02-SUMMARY.md`
</output>
