---
phase: 19-operator-ratelimiter
plan: 04
type: execute
wave: 3
depends_on: ["19-02"]
files_modified:
  - packages/operator-ratelimiter/src/operator_ratelimiter/factory.py
  - packages/operator-ratelimiter/src/operator_ratelimiter/__init__.py
  - packages/operator-core/src/operator_core/cli/subject_factory.py
autonomous: true

must_haves:
  truths:
    - "create_ratelimiter_subject_and_checker() returns tuple of (subject, checker)"
    - "CLI --subject ratelimiter creates RateLimiterSubject"
    - "operator-ratelimiter package exports RateLimiterSubject and RateLimiterInvariantChecker"
  artifacts:
    - path: "packages/operator-ratelimiter/src/operator_ratelimiter/factory.py"
      provides: "Factory function for CLI integration"
      exports: ["create_ratelimiter_subject_and_checker"]
    - path: "packages/operator-ratelimiter/src/operator_ratelimiter/__init__.py"
      provides: "Package exports"
      contains: "RateLimiterSubject"
    - path: "packages/operator-core/src/operator_core/cli/subject_factory.py"
      provides: "CLI subject factory with ratelimiter support"
      contains: "ratelimiter"
  key_links:
    - from: "subject_factory.py"
      to: "operator_ratelimiter.factory"
      via: "lazy import of create_ratelimiter_subject_and_checker"
      pattern: "from operator_ratelimiter.factory import"
    - from: "factory.py"
      to: "subject.py"
      via: "imports RateLimiterSubject"
      pattern: "from operator_ratelimiter.subject import"
---

<objective>
Create factory function and integrate with CLI for subject selection.

Purpose: Enable the operator CLI to create RateLimiterSubject instances via --subject ratelimiter, proving the abstraction allows switching between TiKV and rate limiter monitoring.

Output:
- factory.py with create_ratelimiter_subject_and_checker()
- Updated __init__.py with package exports
- Updated subject_factory.py with ratelimiter case
</objective>

<execution_context>
@/Users/jrtipton/.claude/get-shit-done/workflows/execute-plan.md
@/Users/jrtipton/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/19-operator-ratelimiter/19-01-SUMMARY.md
@.planning/phases/19-operator-ratelimiter/19-02-SUMMARY.md

# Reference implementation
@packages/operator-tikv/src/operator_tikv/factory.py
@packages/operator-tikv/src/operator_tikv/__init__.py
@packages/operator-core/src/operator_core/cli/subject_factory.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create factory function</name>
  <files>
    packages/operator-ratelimiter/src/operator_ratelimiter/factory.py
  </files>
  <action>
Create factory function following operator-tikv/factory.py pattern:

1. Create `factory.py`:
   ```python
   """
   Factory function for creating rate limiter subject and checker instances.

   This module provides a factory function for CLI integration, allowing
   the operator-core CLI to create rate limiter-specific instances without
   direct imports from operator-ratelimiter.
   """

   import httpx
   import redis.asyncio as redis

   from operator_ratelimiter.invariants import RateLimiterInvariantChecker
   from operator_ratelimiter.ratelimiter_client import RateLimiterClient
   from operator_ratelimiter.redis_client import RedisClient
   from operator_ratelimiter.prom_client import PrometheusClient
   from operator_ratelimiter.subject import RateLimiterSubject


   def create_ratelimiter_subject_and_checker(
       ratelimiter_url: str,
       redis_url: str,
       prometheus_url: str,
       ratelimiter_http: httpx.AsyncClient | None = None,
       redis_client: redis.Redis | None = None,
       prom_http: httpx.AsyncClient | None = None,
   ) -> tuple[RateLimiterSubject, RateLimiterInvariantChecker]:
       """
       Create a rate limiter subject and checker pair.

       Factory function for CLI integration without direct imports.

       Args:
           ratelimiter_url: Rate limiter management API URL (e.g., "http://ratelimiter1:8080")
           redis_url: Redis connection URL (e.g., "redis://redis:6379")
           prometheus_url: Prometheus API URL (e.g., "http://prometheus:9090")
           ratelimiter_http: Optional pre-configured httpx client for management API.
               If None, a new client is created with 10s timeout.
           redis_client: Optional pre-configured Redis client.
               If None, a new client is created from redis_url.
           prom_http: Optional pre-configured httpx client for Prometheus.
               If None, a new client is created with 10s timeout.

       Returns:
           Tuple of (RateLimiterSubject, RateLimiterInvariantChecker) instances ready for use.

       Example:
           subject, checker = create_ratelimiter_subject_and_checker(
               ratelimiter_url="http://ratelimiter1:8080",
               redis_url="redis://redis:6379",
               prometheus_url="http://prometheus:9090",
           )

           # Use with generic protocols
           observation = await subject.observe()
           violations = checker.check(observation)
       """
       if ratelimiter_http is None:
           ratelimiter_http = httpx.AsyncClient(base_url=ratelimiter_url, timeout=10.0)
       if redis_client is None:
           redis_client = redis.from_url(redis_url, decode_responses=True)
       if prom_http is None:
           prom_http = httpx.AsyncClient(base_url=prometheus_url, timeout=10.0)

       subject = RateLimiterSubject(
           ratelimiter=RateLimiterClient(http=ratelimiter_http),
           redis=RedisClient(redis=redis_client),
           prom=PrometheusClient(http=prom_http),
       )
       checker = RateLimiterInvariantChecker()

       return subject, checker
   ```

2. Important: Use `decode_responses=True` for Redis client (matches ratelimiter-service pattern)
  </action>
  <verify>
```bash
cd packages/operator-ratelimiter && python -c "
from operator_ratelimiter.factory import create_ratelimiter_subject_and_checker
print('Factory function imports successfully')
"
```
  </verify>
  <done>create_ratelimiter_subject_and_checker() exists and follows TiKV factory pattern</done>
</task>

<task type="auto">
  <name>Task 2: Update package exports</name>
  <files>
    packages/operator-ratelimiter/src/operator_ratelimiter/__init__.py
  </files>
  <action>
Update __init__.py with public exports following operator-tikv pattern:

```python
"""
operator-ratelimiter - Rate limiter subject implementation for the AI-powered operator.

This package provides RateLimiterSubject and RateLimiterInvariantChecker
for monitoring distributed rate limiter clusters.
"""

from operator_ratelimiter.factory import create_ratelimiter_subject_and_checker
from operator_ratelimiter.invariants import RateLimiterInvariantChecker
from operator_ratelimiter.subject import RateLimiterSubject

__all__ = [
    "RateLimiterSubject",
    "RateLimiterInvariantChecker",
    "create_ratelimiter_subject_and_checker",
]
```
  </action>
  <verify>
```bash
cd packages/operator-ratelimiter && python -c "
from operator_ratelimiter import (
    RateLimiterSubject,
    RateLimiterInvariantChecker,
    create_ratelimiter_subject_and_checker,
)
print('All exports work')
"
```
  </verify>
  <done>Package exports RateLimiterSubject, RateLimiterInvariantChecker, and create_ratelimiter_subject_and_checker</done>
</task>

<task type="auto">
  <name>Task 3: Integrate with CLI subject factory</name>
  <files>
    packages/operator-core/src/operator_core/cli/subject_factory.py
  </files>
  <action>
Update CLI subject factory to support ratelimiter subject:

1. Update AVAILABLE_SUBJECTS to include "ratelimiter":
   ```python
   AVAILABLE_SUBJECTS = ["tikv", "ratelimiter"]
   ```

2. Add ratelimiter case to create_subject():
   ```python
   async def create_subject(
       subject_name: str,
       **kwargs: Any,
   ) -> tuple["SubjectProtocol", "InvariantCheckerProtocol"]:
       """..."""
       if subject_name == "tikv":
           from operator_tikv.factory import create_tikv_subject_and_checker
           return create_tikv_subject_and_checker(**kwargs)
       elif subject_name == "ratelimiter":
           # Lazy import to avoid loading ratelimiter package unless needed
           from operator_ratelimiter.factory import create_ratelimiter_subject_and_checker
           return create_ratelimiter_subject_and_checker(**kwargs)
       else:
           raise ValueError(
               f"Unknown subject '{subject_name}'. "
               f"Available subjects: {', '.join(AVAILABLE_SUBJECTS)}"
           )
   ```

3. Update docstring example to show ratelimiter:
   ```python
   """
   ...
   Example:
       # TiKV subject
       subject, checker = await create_subject(
           "tikv",
           pd_endpoint="http://pd:2379",
           prometheus_url="http://prometheus:9090",
       )

       # Rate limiter subject
       subject, checker = await create_subject(
           "ratelimiter",
           ratelimiter_url="http://ratelimiter:8080",
           redis_url="redis://redis:6379",
           prometheus_url="http://prometheus:9090",
       )
   """
   ```
  </action>
  <verify>
```bash
cd /Users/jrtipton/x/operator && python -c "
from operator_core.cli.subject_factory import AVAILABLE_SUBJECTS, create_subject

# Check ratelimiter is in available subjects
assert 'ratelimiter' in AVAILABLE_SUBJECTS
print(f'Available subjects: {AVAILABLE_SUBJECTS}')
"
```
  </verify>
  <done>CLI subject_factory supports --subject ratelimiter with lazy import</done>
</task>

</tasks>

<verification>
After all tasks complete:

```bash
# Install operator-ratelimiter if not already installed
cd /Users/jrtipton/x/operator/packages/operator-ratelimiter && pip install -e .

# Verify full integration chain
cd /Users/jrtipton/x/operator && python -c "
from operator_core.cli.subject_factory import create_subject, get_available_subjects

# Check available subjects
subjects = get_available_subjects()
assert 'tikv' in subjects
assert 'ratelimiter' in subjects
print(f'Available subjects: {subjects}')

# Note: Can't fully test create_subject without running services,
# but we can verify the import chain works
print('Integration chain verified')
"

# Run existing operator-core tests to ensure no regressions
cd /Users/jrtipton/x/operator && python -m pytest packages/operator-core/tests/ -v --tb=short -k "not integration"
```
</verification>

<success_criteria>
- create_ratelimiter_subject_and_checker() works with correct parameters
- Package __init__.py exports all public classes and factory
- CLI subject_factory.py includes "ratelimiter" in AVAILABLE_SUBJECTS
- create_subject("ratelimiter", ...) returns (RateLimiterSubject, RateLimiterInvariantChecker)
- Lazy imports prevent loading operator-ratelimiter unless requested
</success_criteria>

<output>
After completion, create `.planning/phases/19-operator-ratelimiter/19-04-SUMMARY.md`
</output>
