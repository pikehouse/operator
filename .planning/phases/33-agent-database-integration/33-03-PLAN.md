---
phase: 33-agent-database-integration
plan: 03
type: execute
wave: 2
depends_on: ["33-01"]
files_modified:
  - packages/operator-core/tests/test_agent_database.py
autonomous: true

must_haves:
  truths:
    - "Unit test verifies TicketOpsDB creates schema on empty database"
    - "Unit test verifies schema initialization is idempotent"
    - "Unit test verifies poll_for_open_ticket returns None on empty database"
  artifacts:
    - path: "packages/operator-core/tests/test_agent_database.py"
      provides: "Unit tests for agent database initialization"
      contains: "def test_ticket_ops_initializes_schema"
      min_lines: 30
  key_links:
    - from: "test_agent_database.py"
      to: "operator_core.agent_lab.ticket_ops.TicketOpsDB"
      via: "import and test"
      pattern: "from operator_core.agent_lab.ticket_ops import TicketOpsDB"
---

<objective>
Create unit tests verifying agent schema initialization works correctly.

Purpose: TEST-03 requirement - ensure TicketOpsDB properly initializes database schema and handles empty database gracefully.

Output: New test file test_agent_database.py with schema initialization tests
</objective>

<execution_context>
@/Users/jrtipton/.claude/get-shit-done/workflows/execute-plan.md
@/Users/jrtipton/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/33-agent-database-integration/33-RESEARCH.md

# Test pattern to follow
@packages/operator-core/tests/test_loop_audit.py

# Module under test (will be updated by Plan 01)
@packages/operator-core/src/operator_core/agent_lab/ticket_ops.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create test_agent_database.py</name>
  <files>packages/operator-core/tests/test_agent_database.py</files>
  <action>
Create new test file following test_loop_audit.py pattern:

```python
"""
Unit tests for agent database initialization.

Tests verify that TicketOpsDB properly initializes schema on empty
databases and handles empty state gracefully (TEST-03).
"""

import tempfile
from pathlib import Path

import pytest

from operator_core.agent_lab.ticket_ops import TicketOpsDB


class TestTicketOpsSchemaInit:
    """Tests for TicketOpsDB schema initialization."""

    def test_initializes_schema_on_empty_database(self):
        """Verify TicketOpsDB creates schema on first connection (DEMO-01)."""
        with tempfile.NamedTemporaryFile(suffix=".db", delete=False) as tmp:
            db_path = Path(tmp.name)

        try:
            # Delete to ensure truly empty database
            db_path.unlink()

            # Open connection - should initialize schema automatically
            with TicketOpsDB(db_path) as db:
                # Query should succeed without "no such table" error
                ticket = db.poll_for_open_ticket()
                assert ticket is None  # Empty database, no tickets

        finally:
            db_path.unlink(missing_ok=True)

    def test_schema_init_is_idempotent(self):
        """Verify TicketOpsDB is safe to call on existing database."""
        with tempfile.NamedTemporaryFile(suffix=".db", delete=False) as tmp:
            db_path = Path(tmp.name)

        try:
            # First connection creates schema
            with TicketOpsDB(db_path) as db:
                pass

            # Second connection should not error (CREATE IF NOT EXISTS)
            with TicketOpsDB(db_path) as db:
                ticket = db.poll_for_open_ticket()
                assert ticket is None

            # Third connection just to be sure
            with TicketOpsDB(db_path) as db:
                ticket = db.poll_for_open_ticket()
                assert ticket is None

        finally:
            db_path.unlink(missing_ok=True)

    def test_poll_returns_none_on_empty_database(self):
        """Verify poll_for_open_ticket returns None when no tickets exist (DEMO-02)."""
        with tempfile.NamedTemporaryFile(suffix=".db", delete=False) as tmp:
            db_path = Path(tmp.name)

        try:
            with TicketOpsDB(db_path) as db:
                # Should return None, not raise exception
                result = db.poll_for_open_ticket()
                assert result is None

        finally:
            db_path.unlink(missing_ok=True)


class TestTicketOpsOperations:
    """Tests for TicketOpsDB ticket operations."""

    def test_update_methods_exist(self):
        """Verify update methods are available on TicketOpsDB."""
        with tempfile.NamedTemporaryFile(suffix=".db", delete=False) as tmp:
            db_path = Path(tmp.name)

        try:
            with TicketOpsDB(db_path) as db:
                # Verify methods exist (don't call - no tickets to update)
                assert hasattr(db, "update_ticket_resolved")
                assert hasattr(db, "update_ticket_escalated")
                assert callable(db.update_ticket_resolved)
                assert callable(db.update_ticket_escalated)

        finally:
            db_path.unlink(missing_ok=True)

    def test_context_manager_closes_connection(self):
        """Verify TicketOpsDB properly closes connection on exit."""
        with tempfile.NamedTemporaryFile(suffix=".db", delete=False) as tmp:
            db_path = Path(tmp.name)

        try:
            db = TicketOpsDB(db_path)

            # Before entering context, connection should be None
            assert db._conn is None

            with db:
                # Inside context, connection should exist
                assert db._conn is not None

            # After exiting context, connection should be closed
            assert db._conn is None

        finally:
            db_path.unlink(missing_ok=True)
```

Key points:
- Use tempfile.NamedTemporaryFile pattern from test_loop_audit.py
- Test empty database handling (DEMO-02)
- Test schema initialization (DEMO-01)
- Test idempotency (multiple opens work)
- Clean up temp files in finally blocks
  </action>
  <verify>
Run: cd /Users/jrtipton/x/operator/packages/operator-core && python -m pytest tests/test_agent_database.py -v
  </verify>
  <done>
- test_agent_database.py exists with 5+ test functions
- All tests pass when run with pytest
- Tests cover schema init, idempotency, empty database handling
  </done>
</task>

<task type="auto">
  <name>Task 2: Run full test suite to verify no regressions</name>
  <files>packages/operator-core/tests/test_agent_database.py</files>
  <action>
Run the complete test suite to verify changes don't break existing functionality:

1. Run new tests:
   cd /Users/jrtipton/x/operator/packages/operator-core && python -m pytest tests/test_agent_database.py -v

2. Run related tests (audit log tests use similar patterns):
   cd /Users/jrtipton/x/operator/packages/operator-core && python -m pytest tests/test_loop_audit.py -v

3. If any tests fail, diagnose and fix

4. Verify test output shows all tests passing
  </action>
  <verify>
- pytest tests/test_agent_database.py shows all tests PASSED
- pytest tests/test_loop_audit.py still passes (no regressions)
  </verify>
  <done>
- All new tests pass
- Existing related tests still pass
- No regressions introduced
  </done>
</task>

</tasks>

<verification>
1. Test file exists: ls packages/operator-core/tests/test_agent_database.py
2. Tests pass: pytest tests/test_agent_database.py -v shows PASSED
3. No regressions: pytest tests/test_loop_audit.py -v still passes
</verification>

<success_criteria>
- test_agent_database.py created with comprehensive schema init tests
- All tests pass verifying DEMO-01, DEMO-02, TEST-03 requirements
- Tests follow project patterns (tempfile, pytest, cleanup in finally)
- No regressions in existing test suite
</success_criteria>

<output>
After completion, create `.planning/phases/33-agent-database-integration/33-03-SUMMARY.md`
</output>
