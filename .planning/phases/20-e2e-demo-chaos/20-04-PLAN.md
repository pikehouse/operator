---
phase: 20-e2e-demo-chaos
plan: 04
type: execute
wave: 3
depends_on: ["20-02", "20-03"]
files_modified:
  - demo/tui_integration.py
  - scripts/run-demo.sh
autonomous: true

must_haves:
  truths:
    - "TUI integration connects demo runner to Rich 5-panel layout"
    - "Same TUI panels work for both TiKV and rate limiter"
    - "Script allows selecting subject via command-line argument"
  artifacts:
    - path: "demo/tui_integration.py"
      provides: "Full TUI demo with panels, subprocess management"
      min_lines: 150
    - path: "scripts/run-demo.sh"
      provides: "Shell script to run demos with subject selection"
      min_lines: 20
  key_links:
    - from: "demo/tui_integration.py"
      to: "packages/operator-core/src/operator_core/tui/layout.py"
      via: "create_layout import"
      pattern: "from operator_core.tui.layout import"
    - from: "scripts/run-demo.sh"
      to: "demo/tui_integration.py"
      via: "python invocation"
      pattern: "python.*demo"
---

<objective>
Integrate demo runner with existing Rich TUI 5-panel layout for full-featured demos.

Purpose: Connect the subject-agnostic demo infrastructure (chapters, health pollers, chaos) with the existing TUI rendering to create production-quality demos for both subjects.

Output: Full TUI demo capability with panel updates, subprocess output streaming, and command-line subject selection.
</objective>

<execution_context>
@/Users/jrtipton/.claude/get-shit-done/workflows/execute-plan.md
@/Users/jrtipton/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/STATE.md
@.planning/phases/20-e2e-demo-chaos/20-02-SUMMARY.md
@.planning/phases/20-e2e-demo-chaos/20-03-SUMMARY.md

# Reference existing TUI infrastructure
@packages/operator-core/src/operator_core/tui/controller.py
@packages/operator-core/src/operator_core/tui/layout.py
@packages/operator-core/src/operator_core/tui/subprocess.py
@packages/operator-core/src/operator_core/tui/keyboard.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create TUI-integrated demo controller</name>
  <files>demo/tui_integration.py</files>
  <action>
Create `demo/tui_integration.py` with `TUIDemoController` class that:

1. Combines existing TUI infrastructure with new demo abstractions:
   - Uses create_layout() from operator_core.tui.layout
   - Uses SubprocessManager from operator_core.tui.subprocess
   - Uses KeyboardTask from operator_core.tui.keyboard
   - Uses make_panel, make_cluster_panel from operator_core.tui.layout
   - Uses DemoState from demo.types
   - Uses HealthPollerProtocol from demo.types

2. Constructor accepts:
   - subject_name: str
   - chapters: list[Chapter]
   - health_poller: HealthPollerProtocol
   - compose_file: Path
   - console: Console | None = None

3. Key methods:
   - async def run(): Main entry point
     - Register signal handlers
     - Spawn monitor subprocess: python -m operator_core.cli.main monitor run --subject {subject} -i 5
     - Spawn agent subprocess: python -m operator_core.cli.main agent start --subject {subject} -i 5
     - Start health poller task
     - Enter Rich Live context
     - Run update loop + keyboard handler

   - _refresh_panels(): Update all 5 panels
     - Cluster panel: format health from health_poller.get_health()
     - Narration panel: current chapter content
     - Monitor panel: subprocess output
     - Agent panel: subprocess output
     - Workload panel: placeholder (no workload tracking for rate limiter)

   - _handle_key(): Chapter progression
     - Same pattern as existing TUIController
     - Execute on_enter callbacks
     - Handle auto_advance

4. Health panel formatting:
   - For TiKV: use existing format_cluster_panel pattern
   - For rate limiter: create format_ratelimiter_panel that shows:
     - Node list with up/down status
     - Redis connectivity status
   - Detect subject by checking health dict keys

5. Subject CLI argument:
   - "tikv" or "ratelimiter"
   - Used to select --subject flag for monitor/agent subprocess

Pattern: Heavily based on existing TUIController but parameterized by subject.
  </action>
  <verify>python -c "from demo.tui_integration import TUIDemoController; print('TUI OK')"</verify>
  <done>TUIDemoController integrates with existing TUI infrastructure</done>
</task>

<task type="auto">
  <name>Task 2: Create demo runner shell script</name>
  <files>scripts/run-demo.sh</files>
  <action>
Create `scripts/run-demo.sh` with:

1. Usage message:
   ```
   Usage: ./scripts/run-demo.sh [tikv|ratelimiter]

   Run the chaos demo for the specified subject.
   ```

2. Subject argument parsing:
   - Default to "tikv" if no argument
   - Validate argument is "tikv" or "ratelimiter"

3. For TiKV:
   - Set COMPOSE_FILE=subjects/tikv/docker-compose.yaml
   - Run: python -m demo.tikv (or demo.tui_integration with tikv)

4. For Rate Limiter:
   - Set COMPOSE_FILE=docker/docker-compose.yml
   - Ensure rate limiter cluster is running: docker compose -f $COMPOSE_FILE up -d
   - Run: python -m demo.ratelimiter (or demo.tui_integration with ratelimiter)

5. Make executable with shebang: #!/usr/bin/env bash

6. Add helpful output:
   - Print which subject is being demoed
   - Print instructions if cluster not running

Pattern: Similar to existing scripts/run-tui.sh
  </action>
  <verify>test -x scripts/run-demo.sh && head -5 scripts/run-demo.sh</verify>
  <done>run-demo.sh script allows running demo for either subject</done>
</task>

<task type="auto">
  <name>Task 3: Create main entry point that routes to TUI controller</name>
  <files>demo/__main__.py</files>
  <action>
Create `demo/__main__.py` to allow `python -m demo` invocation:

1. Parse command line:
   - Accept positional argument: subject (tikv or ratelimiter)
   - Default to tikv

2. Import and configure based on subject:
   - If tikv: import from demo.tikv (chapters, health poller, chaos)
   - If ratelimiter: import from demo.ratelimiter (chapters, health poller, chaos)

3. Create TUIDemoController with appropriate config:
   - subject_name
   - chapters from subject module
   - health_poller from subject module
   - compose_file (subjects/tikv/docker-compose.yaml or docker/docker-compose.yml)

4. Run: asyncio.run(controller.run())

5. Handle KeyboardInterrupt gracefully

This allows:
- `python -m demo` (defaults to tikv)
- `python -m demo tikv`
- `python -m demo ratelimiter`
  </action>
  <verify>python -c "import demo.__main__; print('Main OK')"</verify>
  <done>Demo can be invoked via `python -m demo [subject]`</done>
</task>

</tasks>

<verification>
1. TUIDemoController imports existing TUI components
2. Health panel formats correctly for both subjects
3. run-demo.sh executes without error (may fail on missing cluster)
4. `python -m demo --help` or similar shows usage
</verification>

<success_criteria>
- Same TUI layout (5 panels) works for both TiKV and rate limiter
- Monitor/agent subprocesses use correct --subject flag
- Health panel adapts to subject's health data format
- Script provides easy entry point for either subject
</success_criteria>

<output>
After completion, create `.planning/phases/20-e2e-demo-chaos/20-04-SUMMARY.md`
</output>
