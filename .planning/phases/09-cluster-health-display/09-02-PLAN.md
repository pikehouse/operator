---
phase: 09-cluster-health-display
plan: 02
type: execute
wave: 2
depends_on: ["09-01"]
files_modified:
  - packages/operator-core/src/operator_core/tui/controller.py
  - packages/operator-core/src/operator_core/tui/layout.py
autonomous: false

must_haves:
  truths:
    - "Cluster panel displays all 6 nodes (3 TiKV, 3 PD) with health status"
    - "Healthy nodes show green indicator"
    - "Down nodes show red indicator"
    - "Panel border turns red when monitor detects violations"
  artifacts:
    - path: "packages/operator-core/src/operator_core/tui/controller.py"
      provides: "TUIController with health poller integration"
      contains: "ClusterHealthPoller"
    - path: "packages/operator-core/src/operator_core/tui/layout.py"
      provides: "make_cluster_panel function"
      exports: ["make_cluster_panel"]
  key_links:
    - from: "packages/operator-core/src/operator_core/tui/controller.py"
      to: "ClusterHealthPoller"
      via: "TaskGroup task creation"
      pattern: "tg\\.create_task.*health_poller"
    - from: "packages/operator-core/src/operator_core/tui/controller.py"
      to: "parse_monitor_output_for_detection"
      via: "Monitor output parsing in _refresh_panels"
      pattern: "parse_monitor_output_for_detection"
---

<objective>
Integrate ClusterHealthPoller into TUIController for live cluster health display with detection highlighting.

Purpose: Complete the TUI-02 and TUI-04 requirements by showing live health status in the cluster panel with visual emphasis when issues are detected.

Output: TUIController displays real-time cluster health with color-coded indicators and detection highlighting.
</objective>

<execution_context>
@/Users/jrtipton/.claude/get-shit-done/workflows/execute-plan.md
@/Users/jrtipton/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/09-cluster-health-display/09-RESEARCH.md
@.planning/phases/09-cluster-health-display/09-01-SUMMARY.md

# Existing TUI modules to modify
@packages/operator-core/src/operator_core/tui/controller.py
@packages/operator-core/src/operator_core/tui/layout.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add make_cluster_panel function to layout.py</name>
  <files>packages/operator-core/src/operator_core/tui/layout.py</files>
  <action>
Add make_cluster_panel() function to layout.py for creating styled cluster panels with detection highlighting:

```python
def make_cluster_panel(
    content: str,
    has_issues: bool = False,
    detection_active: bool = False,
) -> Panel:
    """
    Create a styled cluster panel with detection highlighting.

    Per RESEARCH.md Pattern 4: Detection Highlighting via Border Color.

    Args:
        content: Rich markup content for the panel
        has_issues: True if any node is not UP
        detection_active: True if monitor recently detected a violation

    Returns:
        Panel with appropriate border style:
        - detection_active: bold red border, "!" in title
        - has_issues: yellow border
        - all healthy: cyan border (default)
    """
    if detection_active:
        # Monitor detected an issue - emphasize with red border
        border_style = "bold red"
        title = "[bold red]! Cluster Status ![/bold red]"
    elif has_issues:
        # Cluster has issues but no active detection
        border_style = "yellow"
        title = "[bold yellow]Cluster Status[/bold yellow]"
    else:
        # All healthy
        border_style = "cyan"
        title = "[bold cyan]Cluster Status[/bold cyan]"

    return Panel(
        content,
        title=title,
        border_style=border_style,
        padding=(0, 1),
    )
```

This keeps the existing make_panel() function unchanged for other panels.
  </action>
  <verify>
```bash
cd /Users/jrtipton/x/operator && python -c "
from operator_core.tui.layout import make_cluster_panel

# Test normal state
panel = make_cluster_panel('test', has_issues=False, detection_active=False)
assert 'cyan' in str(panel.border_style), f'Expected cyan border, got {panel.border_style}'
print('Normal state: cyan border')

# Test has_issues state
panel = make_cluster_panel('test', has_issues=True, detection_active=False)
assert 'yellow' in str(panel.border_style), f'Expected yellow border, got {panel.border_style}'
print('Has issues state: yellow border')

# Test detection_active state (highest priority)
panel = make_cluster_panel('test', has_issues=True, detection_active=True)
assert 'red' in str(panel.border_style), f'Expected red border, got {panel.border_style}'
print('Detection active state: red border')

print('All make_cluster_panel tests passed!')
"
```
  </verify>
  <done>make_cluster_panel() function added with detection highlighting logic</done>
</task>

<task type="auto">
  <name>Task 2: Integrate ClusterHealthPoller into TUIController</name>
  <files>packages/operator-core/src/operator_core/tui/controller.py</files>
  <action>
Modify TUIController to integrate health polling:

1. **Add imports at top:**
```python
from operator_core.tui.health import (
    ClusterHealthPoller,
    format_cluster_panel,
    parse_monitor_output_for_detection,
)
from operator_core.tui.layout import create_layout, make_panel, make_cluster_panel
```

2. **Add health_poller attribute in __init__:**
```python
self._health_poller: ClusterHealthPoller | None = None
```

3. **In run(), create health poller AFTER signal handlers, BEFORE Live context:**
```python
# After subprocess spawning, before Live context
self._health_poller = ClusterHealthPoller(
    pd_endpoint="http://localhost:2379",
    poll_interval=2.0,
)
```

4. **In run(), add health poller to TaskGroup:**
```python
async with asyncio.TaskGroup() as tg:
    # Reader tasks for subprocess output
    tg.create_task(self._subprocess_mgr.read_output(monitor_proc))
    tg.create_task(self._subprocess_mgr.read_output(agent_proc))
    # Health poller task
    tg.create_task(self._health_poller.run())
    # Update loop
    tg.create_task(self._update_loop(live))
```

5. **In _handle_signal(), also stop health poller:**
```python
if self._health_poller is not None:
    self._health_poller.stop()
```

6. **Modify _refresh_panels() to update cluster panel and parse monitor output:**
```python
def _refresh_panels(self) -> None:
    """
    Refresh panel contents from subprocess output and health status.
    """
    if self._subprocess_mgr is None:
        return

    # Update monitor panel and check for detection events
    monitor_buf = self._subprocess_mgr.get_buffer("monitor")
    if monitor_buf:
        # Check recent lines for detection events
        for line in monitor_buf.get_lines(n=5):
            detection = parse_monitor_output_for_detection(line)
            if detection is not None and self._health_poller is not None:
                self._health_poller.set_detection_active(detection)

        self._layout["main"]["monitor"].update(
            make_panel(monitor_buf.get_text(n=20), "Monitor", "blue")
        )

    # Update agent panel
    agent_buf = self._subprocess_mgr.get_buffer("agent")
    if agent_buf:
        self._layout["main"]["agent"].update(
            make_panel(agent_buf.get_text(n=20), "Agent", "green")
        )

    # Update cluster panel with health status
    if self._health_poller is not None:
        health = self._health_poller.get_health()
        if health:
            content = format_cluster_panel(health)
            self._layout["cluster"].update(
                make_cluster_panel(
                    content,
                    has_issues=health.has_issues,
                    detection_active=self._health_poller.is_detection_active(),
                )
            )
```

Follow existing code style: docstrings, type hints, consistent formatting.
  </action>
  <verify>
```bash
cd /Users/jrtipton/x/operator && python -c "
from operator_core.tui.controller import TUIController
from operator_core.tui.health import ClusterHealthPoller

# Verify imports work
print('Imports OK')

# Verify TUIController has health_poller attribute after init
controller = TUIController()
assert hasattr(controller, '_health_poller'), 'Missing _health_poller attribute'
print('TUIController has _health_poller attribute')

# Verify ClusterHealthPoller is importable from health module
print('All integration checks passed!')
"
```
  </verify>
  <done>TUIController integrated with ClusterHealthPoller in TaskGroup, _refresh_panels updates cluster panel</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Complete cluster health display integration:
- Cluster panel shows live health status from PD API
- Green indicators (●) for healthy nodes
- Red indicators (✗) for down nodes
- Panel border changes to red when monitor detects violations
  </what-built>
  <how-to-verify>
1. **Start TiKV cluster:**
```bash
cd /Users/jrtipton/x/operator/cluster && docker compose up -d
```

2. **Wait for cluster to stabilize (30 seconds):**
```bash
sleep 30
```

3. **Run TUI demo:**
```bash
cd /Users/jrtipton/x/operator && python -m operator_core.tui.controller
```

4. **Verify cluster panel shows:**
   - All 6 nodes (tikv-1, tikv-2, tikv-3, pd-1, pd-2, pd-3)
   - Green indicators (●) next to each node name
   - Cyan border (normal state)

5. **Test detection highlighting (optional):**
   - Kill a TiKV node: `docker stop tikv-1`
   - Wait for monitor to detect (5-10 seconds)
   - Verify: Panel border turns red, node shows red indicator

6. **Exit cleanly:** Press Ctrl+C
   - Verify: No errors, "TUI shutdown complete" message

7. **(If tested) Restore node:**
```bash
docker start tikv-1
```

**Expected output:**
- Cluster panel with 6 nodes, all green when healthy
- Detection highlighting (red border) when violations occur
- Clean shutdown on Ctrl+C
  </how-to-verify>
  <resume-signal>Type "approved" if cluster health displays correctly, or describe any issues</resume-signal>
</task>

</tasks>

<verification>
After all tasks complete and checkpoint approved:

1. **Requirements satisfied:**
   - TUI-02: Color-coded health indicators (green/red) for all nodes
   - TUI-04: Detection highlighting via panel border color change

2. **Success criteria from roadmap:**
   - Cluster panel shows all 6 nodes (3 TiKV, 3 PD) with health status
   - Healthy nodes display green indicator
   - Down nodes display red indicator
   - When monitor detects an issue, visual emphasis appears
</verification>

<success_criteria>
- TUIController creates ClusterHealthPoller in run()
- Health poller runs as TaskGroup task
- Cluster panel updates with live health data
- Green indicators for UP nodes, red for DOWN
- Panel border changes to red on detection events
- Clean shutdown stops health poller
- Human verification confirms visual display is correct
</success_criteria>

<output>
After completion, create `.planning/phases/09-cluster-health-display/09-02-SUMMARY.md`
</output>
