---
phase: 34-demo-e2e-validation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified: []
autonomous: false

must_haves:
  truths:
    - "TiKV demo completes startup -> fault injection -> agent diagnosis -> resolution flow"
    - "Rate limiter demo completes startup -> fault injection -> agent diagnosis -> resolution flow"
    - "Agent panel displays subprocess output in real-time during diagnosis"
    - "Demo chapters advance correctly with proper timing and state transitions"
  artifacts: []
  key_links:
    - from: "demo/tikv.py"
      to: "agent_lab/loop.py"
      via: "subprocess spawn"
      pattern: "python -m operator_core.agent_lab"
    - from: "demo/ratelimiter.py"
      to: "agent_lab/loop.py"
      via: "subprocess spawn"
      pattern: "python -m operator_core.agent_lab"
---

<objective>
Validate that both TiKV and rate limiter demos run end-to-end with the v3.0 agent_lab architecture.

Purpose: Confirm Phase 33 database integration works in practice before writing automated tests.
Output: Human verification that DEMO-04, DEMO-05, DEMO-06 requirements are met.
</objective>

<execution_context>
@/Users/jrtipton/.claude/get-shit-done/workflows/execute-plan.md
@/Users/jrtipton/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/34-demo-e2e-validation/34-RESEARCH.md
@demo/tikv.py
@demo/ratelimiter.py
@demo/tui_integration.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Start TiKV cluster and run TiKV demo</name>
  <files>None (validation only)</files>
  <action>
1. Ensure TiKV cluster is running:
   ```bash
   cd /Users/jrtipton/x/operator
   docker compose -f docker/tikv/docker-compose.yml up -d
   ```

2. Wait for cluster to be healthy (~30 seconds):
   ```bash
   curl -s http://localhost:2379/pd/api/v1/members | python3 -c "import json,sys; d=json.load(sys.stdin); print(f'Cluster has {len(d.get(\"members\",[]))} members')"
   ```

3. Start the TiKV demo:
   ```bash
   cd /Users/jrtipton/x/operator
   uv run python -m demo --subject tikv
   ```

4. Observe the demo flow:
   - Press SPACE to advance through chapters
   - Watch for "Stage 3: Fault Injection" (chaos callback kills a TiKV node)
   - Watch monitor panel for "violation(s) detected"
   - Watch agent panel for "[Claude]" reasoning and "[Tool Call]" executions

5. Let demo complete or press 'q' to quit after observing agent diagnosis.

The demo should show:
- Monitor subprocess detecting TiKV node failure
- Agent subprocess starting ticket processing
- Claude reasoning visible in agent panel
- Tool calls (shell commands) visible in agent panel
- Ticket resolution or escalation
  </action>
  <verify>
Demo ran without crashing. Monitor detected violations. Agent panel showed Claude reasoning.
  </verify>
  <done>TiKV demo flow observed working end-to-end</done>
</task>

<task type="auto">
  <name>Task 2: Run Rate Limiter demo</name>
  <files>None (validation only)</files>
  <action>
1. Ensure rate limiter cluster is running:
   ```bash
   cd /Users/jrtipton/x/operator
   docker compose -f docker/docker-compose.yml up -d
   ```

2. Wait for services to be healthy (~15 seconds):
   ```bash
   curl -s http://localhost:8001/health | python3 -c "import json,sys; print(json.load(sys.stdin))"
   ```

3. Start the rate limiter demo:
   ```bash
   cd /Users/jrtipton/x/operator
   uv run python -m demo --subject ratelimiter
   ```

4. Observe the demo flow:
   - Press SPACE to advance through chapters
   - Watch for "Stage 4: Fault Injection" (chaos callback creates over-limit counters)
   - Watch monitor panel for "violation(s) detected"
   - Watch agent panel for "[Claude]" reasoning and "[Tool Call]" executions

5. Let demo complete or press 'q' to quit after observing agent diagnosis.

The demo should show:
- Monitor subprocess detecting rate limit violations
- Agent subprocess starting ticket processing
- Claude reasoning visible in agent panel
- Tool calls (redis-cli, curl) visible in agent panel
- Ticket resolution or escalation
  </action>
  <verify>
Demo ran without crashing. Monitor detected violations. Agent panel showed Claude reasoning.
  </verify>
  <done>Rate limiter demo flow observed working end-to-end</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Both TiKV and rate limiter demos should have run end-to-end with v3.0 agent_lab.
  </what-built>
  <how-to-verify>
Confirm the following were observed:

**DEMO-04 (TiKV demo):**
1. TiKV cluster started without errors
2. Demo TUI launched and showed all panels (narration, status, monitor, agent, workload)
3. Fault injection chapter killed a TiKV node
4. Monitor panel showed "violation(s) detected"
5. Agent panel showed ticket processing with Claude reasoning
6. Demo completed or agent provided diagnosis

**DEMO-05 (Rate limiter demo):**
1. Rate limiter cluster started without errors
2. Demo TUI launched and showed all panels
3. Fault injection chapter created over-limit counters
4. Monitor panel showed "violation(s) detected"
5. Agent panel showed ticket processing with Claude reasoning
6. Demo completed or agent provided diagnosis

**DEMO-06 (Agent panel output):**
1. Agent panel displayed subprocess output in real-time
2. Lines appeared as agent processed (not all at once at the end)
3. Output included "[Claude]", "[Tool Call]", "[Tool Result]" markers

If any of these failed, describe what went wrong.
  </how-to-verify>
  <resume-signal>Type "approved" if all demos worked, or describe issues found</resume-signal>
</task>

</tasks>

<verification>
- TiKV demo ran end-to-end without errors
- Rate limiter demo ran end-to-end without errors
- Agent panel displayed real-time subprocess output
- Both demos completed full flow: startup -> fault -> agent -> resolution
</verification>

<success_criteria>
- DEMO-04: TiKV demo completes full flow
- DEMO-05: Rate limiter demo completes full flow
- DEMO-06: Agent panel displays subprocess output in real-time
- Human has verified all three requirements manually
</success_criteria>

<output>
After completion, create `.planning/phases/34-demo-e2e-validation/34-01-SUMMARY.md`
</output>
