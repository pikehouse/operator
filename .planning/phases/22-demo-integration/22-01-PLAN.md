---
phase: 22-demo-integration
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - demo/tikv.py
  - demo/ratelimiter.py
autonomous: true

must_haves:
  truths:
    - "TiKV demo narratives describe agentic remediation flow (detect, diagnose, act, verify)"
    - "Rate limiter demo narratives describe agentic remediation flow (detect, diagnose, act, verify)"
    - "No observe-only or manual recovery text remains in chapter narratives"
    - "Expected actions are named explicitly (transfer_leader, reset_counter)"
  artifacts:
    - path: "demo/tikv.py"
      provides: "TiKV demo with agentic chapter narratives"
      contains: "transfer_leader"
    - path: "demo/ratelimiter.py"
      provides: "Rate limiter demo with agentic chapter narratives"
      contains: "reset_counter"
  key_links:
    - from: "demo/tikv.py"
      to: "AgentRunner agentic loop"
      via: "Chapter narratives describe agent panel behavior"
      pattern: "Watch.*Agent panel"
    - from: "demo/ratelimiter.py"
      to: "AgentRunner agentic loop"
      via: "Chapter narratives describe agent panel behavior"
      pattern: "Watch.*Agent panel"
---

<objective>
Update both TiKV and rate limiter demo chapter narratives to describe the complete agentic remediation flow.

Purpose: Replace outdated "observe-only" language with narratives that guide viewers through the agentic loop: fault detection, AI diagnosis, action execution, and verification.

Output: Updated chapter narratives in demo/tikv.py and demo/ratelimiter.py that match the actual agent behavior.
</objective>

<execution_context>
@/Users/jrtipton/.claude/get-shit-done/workflows/execute-plan.md
@/Users/jrtipton/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/22-demo-integration/22-RESEARCH.md
@.planning/phases/21-agent-agentic-loop/21-01-SUMMARY.md
@.planning/phases/21-agent-agentic-loop/21-02-SUMMARY.md
@demo/tikv.py
@demo/ratelimiter.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update TiKV demo chapter narratives for agentic flow</name>
  <files>demo/tikv.py</files>
  <action>
Update TiKV demo chapter narratives to describe the complete agentic loop.

Specific changes:

1. **Stage 6: AI Diagnosis** chapter (currently TIKV_CHAPTERS[3]):
   - Replace title with "Stage 6: AI Remediation"
   - Update narration to describe the complete loop:
     - Diagnosis: Claude analyzes the violation
     - Action: transfer_leader to redistribute regions to healthy stores
     - Verify: Agent checks metrics after 5s delay
   - Add "[dim]Agent runs in EXECUTE mode (no approval needed).[/dim]"

2. **Stage 7: Recovery** chapter (create_recovery_chapter function):
   - Remove the "(Agent action execution coming in v2 â€” currently observe-only)" text
   - Update narration to explain this is verification phase:
     - Agent already executed transfer_leader
     - Node restart provides visual recovery
     - Watch Agent panel for verification result
   - Keep existing on_enter callback (node restart)

3. **Stage 5: Detection** chapter (currently TIKV_CHAPTERS[2]):
   - Update narration to mention autonomous remediation coming:
     "Next: Agent will diagnose and remediate automatically."

Search for any remaining "observe" or "manual" text in chapter narrations and remove or update.
  </action>
  <verify>
grep -n "observe\|manual\|coming in v2" demo/tikv.py  # Should return empty
grep -n "transfer_leader" demo/tikv.py  # Should return match
grep -n "EXECUTE mode" demo/tikv.py  # Should return match
  </verify>
  <done>
TiKV demo chapter narratives describe agentic remediation flow with explicit transfer_leader action name, no observe-only or v2 coming text remains.
  </done>
</task>

<task type="auto">
  <name>Task 2: Update rate limiter demo chapter narratives for agentic flow</name>
  <files>demo/ratelimiter.py</files>
  <action>
Update rate limiter demo chapter narratives to describe the complete agentic loop.

Specific changes:

1. **Stage 5: AI Diagnosis** chapter (RATELIMITER_CHAPTERS index 5):
   - Replace title with "Stage 5: AI Remediation"
   - Update narration to describe the complete loop:
     - Diagnosis: AI identifies counter drift root cause
     - Action: reset_counter to realign distributed counters
     - Verify: Agent checks counters are aligned after 5s
   - Add "[dim]Autonomous remediation - no human approval.[/dim]"

2. **Stage 6: Recovery** chapter (RATELIMITER_CHAPTERS index 6):
   - Update narration to explain agent already executed action:
     - "Agent executed reset_counter, verifying fix..."
     - "Watch Agent panel for verification result"
   - Keep auto_advance=True

3. **Stage 9: AI Diagnosis** chapter (RATELIMITER_CHAPTERS index 9 - second anomaly):
   - Replace title with "Stage 9: AI Remediation"
   - Update narration for ghost allowing diagnosis:
     - Same agentic loop pattern
     - Action: reset_counter
     - Verify: Counters back to normal
   - Add "[dim]Same autonomous loop, different anomaly.[/dim]"

4. **Stage 4: Detection** and **Stage 8: Detection** chapters:
   - Add "Next: Agent will diagnose and act automatically."
  </action>
  <verify>
grep -n "reset_counter" demo/ratelimiter.py  # Should return matches
grep -n "autonomous\|EXECUTE\|no.*approval" demo/ratelimiter.py  # Should return matches
grep -n "Remediation" demo/ratelimiter.py  # Should show AI Remediation titles
  </verify>
  <done>
Rate limiter demo chapter narratives describe agentic remediation flow with explicit reset_counter action name for both counter drift and ghost allowing anomalies.
  </done>
</task>

</tasks>

<verification>
After completing both tasks:

1. **Syntax check:**
   ```bash
   python -c "import demo.tikv; import demo.ratelimiter" && echo "Imports OK"
   ```

2. **Narrative content check:**
   ```bash
   # TiKV should have agentic flow keywords
   grep -c "transfer_leader\|EXECUTE\|Remediation\|Agent panel" demo/tikv.py
   # Should be >= 3

   # Rate limiter should have agentic flow keywords
   grep -c "reset_counter\|autonomous\|Remediation\|Agent panel" demo/ratelimiter.py
   # Should be >= 4

   # No observe-only text in either
   grep -l "observe-only\|coming in v2" demo/tikv.py demo/ratelimiter.py
   # Should return empty
   ```

3. **Chapter structure preserved:**
   - TiKV: 8 chapters (Welcome through Complete)
   - Rate limiter: 11 chapters (two anomaly cycles)
</verification>

<success_criteria>
1. TiKV demo chapter narratives updated:
   - Stage 6 titled "AI Remediation" with transfer_leader action named
   - Stage 7 describes verification, no observe-only text
   - All chapters guide viewer to Agent panel for agentic loop

2. Rate limiter demo chapter narratives updated:
   - Stage 5 titled "AI Remediation" with reset_counter action named
   - Stage 9 titled "AI Remediation" with reset_counter action named
   - All diagnosis chapters describe autonomous remediation flow

3. No outdated text remains:
   - No "observe-only" phrases
   - No "(Agent action execution coming in v2...)" text
   - No "manual recovery" references
</success_criteria>

<output>
After completion, create `.planning/phases/22-demo-integration/22-01-SUMMARY.md`
</output>
