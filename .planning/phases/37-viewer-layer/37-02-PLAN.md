---
phase: 37-viewer-layer
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - eval/pyproject.toml
  - eval/src/eval/viewer/__init__.py
  - eval/src/eval/viewer/app.py
  - eval/src/eval/viewer/routes.py
  - eval/src/eval/viewer/templates/base.html
  - eval/src/eval/viewer/templates/campaigns.html
  - eval/src/eval/viewer/templates/campaign.html
  - eval/src/eval/viewer/templates/trial.html
  - eval/src/eval/cli.py
autonomous: true

must_haves:
  truths:
    - "Developer can run `eval viewer` and a web server starts"
    - "Developer can browse to / and see campaign list"
    - "Developer can click a campaign and see its details with trial list"
    - "Developer can click a trial and see full detail with reasoning timeline"
    - "Reasoning timeline shows agent thoughts and commands chronologically"
  artifacts:
    - path: "eval/src/eval/viewer/app.py"
      provides: "FastAPI application setup"
      contains: "FastAPI"
    - path: "eval/src/eval/viewer/routes.py"
      provides: "Route handlers for campaigns, trials"
      contains: "async def get_campaign"
    - path: "eval/src/eval/viewer/templates/trial.html"
      provides: "Trial detail with reasoning timeline"
      contains: "reasoning"
    - path: "eval/src/eval/cli.py"
      provides: "viewer command to start server"
      contains: "def viewer"
  key_links:
    - from: "eval/src/eval/viewer/routes.py"
      to: "eval/src/eval/runner/db.py"
      via: "Database queries for campaigns and trials"
      pattern: "EvalDB"
    - from: "eval/src/eval/viewer/routes.py"
      to: "packages/operator-core/src/operator_core/db/audit_log.py"
      via: "Reasoning entries from agent sessions"
      pattern: "agent_log_entries|AuditLogDB"
---

<objective>
Build web viewer for browsing evaluation campaigns and trials with reasoning display.

Purpose: Provides a visual interface for exploring evaluation results, including agent reasoning timeline that shows how the agent diagnosed and resolved issues.

Output: FastAPI web application with Jinja2 templates, Tailwind CSS styling, and chronological reasoning display.
</objective>

<execution_context>
@/Users/jrtipton/.claude/get-shit-done/workflows/execute-plan.md
@/Users/jrtipton/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/37-viewer-layer/37-CONTEXT.md
@.planning/phases/37-viewer-layer/37-RESEARCH.md

# Existing code
@eval/src/eval/cli.py
@eval/src/eval/runner/db.py
@eval/src/eval/types.py
@eval/src/eval/analysis/types.py
@packages/operator-core/src/operator_core/db/schema.py
@packages/operator-core/src/operator_core/db/audit_log.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add FastAPI dependencies and create viewer package structure</name>
  <files>eval/pyproject.toml, eval/src/eval/viewer/__init__.py, eval/src/eval/viewer/app.py</files>
  <action>
1. Add dependencies to eval/pyproject.toml under [project.dependencies]:
   - fastapi>=0.115.0
   - jinja2>=3.1.0
   - uvicorn>=0.32.0

2. Create templates directory structure:
   ```bash
   mkdir -p eval/src/eval/viewer/templates
   ```

3. Create eval/src/eval/viewer/__init__.py with re-export:
   ```python
   """Web viewer for evaluation campaigns and trials."""

   from .app import create_app

   __all__ = ["create_app"]
   ```

4. Create eval/src/eval/viewer/app.py:
   ```python
   """FastAPI application factory for eval viewer."""

   from fastapi import FastAPI
   from fastapi.templating import Jinja2Templates
   from pathlib import Path


   def create_app(db_path: Path, operator_db_path: Path | None = None) -> FastAPI:
       """Create FastAPI application for viewing eval results.

       Args:
           db_path: Path to eval.db database
           operator_db_path: Optional path to operator.db for reasoning entries

       Returns:
           Configured FastAPI application
       """
       app = FastAPI(title="Eval Viewer")

       templates_dir = Path(__file__).parent / "templates"
       templates = Jinja2Templates(directory=str(templates_dir))

       # Store paths in app state for access in routes
       app.state.db_path = db_path
       app.state.operator_db_path = operator_db_path
       app.state.templates = templates

       # Import and include routes
       from .routes import router
       app.include_router(router)

       return app
   ```
  </action>
  <verify>
Run:
```bash
cd eval && uv sync && python -c "from eval.viewer import create_app; print('OK')"
```
  </verify>
  <done>FastAPI app factory created with Jinja2 templates setup and viewer package structure in place.</done>
</task>

<task type="auto">
  <name>Task 2: Create routes and templates for campaigns and trials</name>
  <files>eval/src/eval/viewer/routes.py, eval/src/eval/viewer/templates/base.html, eval/src/eval/viewer/templates/campaigns.html, eval/src/eval/viewer/templates/campaign.html, eval/src/eval/viewer/templates/trial.html</files>
  <action>
1. Create eval/src/eval/viewer/routes.py with three routes:

```python
"""Route handlers for eval viewer."""

from fastapi import APIRouter, Request
from fastapi.responses import HTMLResponse

from eval.runner.db import EvalDB

router = APIRouter()


@router.get("/", response_class=HTMLResponse)
async def list_campaigns(request: Request):
    """List all campaigns."""
    db = EvalDB(request.app.state.db_path)
    await db.ensure_schema()
    campaigns = await db.get_all_campaigns(limit=100, offset=0)

    return request.app.state.templates.TemplateResponse(
        "campaigns.html",
        {"request": request, "campaigns": campaigns},
    )


@router.get("/campaign/{campaign_id}", response_class=HTMLResponse)
async def get_campaign(request: Request, campaign_id: int):
    """Show campaign detail with trial list."""
    db = EvalDB(request.app.state.db_path)
    await db.ensure_schema()

    campaign = await db.get_campaign(campaign_id)
    if campaign is None:
        return HTMLResponse(content="Campaign not found", status_code=404)

    trials = await db.get_trials(campaign_id)

    return request.app.state.templates.TemplateResponse(
        "campaign.html",
        {"request": request, "campaign": campaign, "trials": trials},
    )


@router.get("/trial/{trial_id}", response_class=HTMLResponse)
async def get_trial(request: Request, trial_id: int):
    """Show trial detail with reasoning timeline."""
    import json

    db = EvalDB(request.app.state.db_path)
    await db.ensure_schema()

    trial = await db.get_trial(trial_id)
    if trial is None:
        return HTMLResponse(content="Trial not found", status_code=404)

    # Parse commands from JSON
    commands = json.loads(trial.commands_json) if trial.commands_json else []

    # Reasoning entries will be added in Task 3
    reasoning_entries = []

    return request.app.state.templates.TemplateResponse(
        "trial.html",
        {
            "request": request,
            "trial": trial,
            "commands": commands,
            "reasoning_entries": reasoning_entries,
        },
    )
```

2. Create eval/src/eval/viewer/templates/base.html:
```html
<!DOCTYPE html>
<html>
<head>
    <title>{% block title %}Eval Viewer{% endblock %}</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 min-h-screen">
    <nav class="bg-white shadow mb-4 px-4 py-2">
        <a href="/" class="text-lg font-bold text-gray-800 hover:text-gray-600">Eval Viewer</a>
    </nav>
    <main class="container mx-auto px-4 pb-8">
        {% block content %}{% endblock %}
    </main>
</body>
</html>
```

3. Create eval/src/eval/viewer/templates/campaigns.html:
```html
{% extends "base.html" %}

{% block title %}Campaigns - Eval Viewer{% endblock %}

{% block content %}
<h1 class="text-2xl font-bold mb-4">Campaigns</h1>

{% if campaigns %}
<div class="bg-white shadow rounded overflow-hidden">
    <table class="min-w-full">
        <thead class="bg-gray-50">
            <tr>
                <th class="px-4 py-2 text-left text-sm font-medium text-gray-500">ID</th>
                <th class="px-4 py-2 text-left text-sm font-medium text-gray-500">Subject</th>
                <th class="px-4 py-2 text-left text-sm font-medium text-gray-500">Chaos</th>
                <th class="px-4 py-2 text-left text-sm font-medium text-gray-500">Trials</th>
                <th class="px-4 py-2 text-left text-sm font-medium text-gray-500">Baseline</th>
                <th class="px-4 py-2 text-left text-sm font-medium text-gray-500">Created</th>
            </tr>
        </thead>
        <tbody class="divide-y divide-gray-200">
            {% for campaign in campaigns %}
            <tr class="hover:bg-gray-50">
                <td class="px-4 py-2">
                    <a href="/campaign/{{ campaign.id }}" class="text-blue-600 hover:underline">{{ campaign.id }}</a>
                </td>
                <td class="px-4 py-2">{{ campaign.subject_name }}</td>
                <td class="px-4 py-2">{{ campaign.chaos_type }}</td>
                <td class="px-4 py-2">{{ campaign.trial_count }}</td>
                <td class="px-4 py-2">{% if campaign.baseline %}Yes{% else %}No{% endif %}</td>
                <td class="px-4 py-2 text-gray-500 text-sm">{{ campaign.created_at[:19] }}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>
{% else %}
<div class="bg-white shadow rounded p-4 text-gray-500">
    No campaigns found. Run some evaluations first.
</div>
{% endif %}
{% endblock %}
```

4. Create eval/src/eval/viewer/templates/campaign.html:
```html
{% extends "base.html" %}

{% block title %}Campaign {{ campaign.id }} - Eval Viewer{% endblock %}

{% block content %}
<div class="mb-4">
    <a href="/" class="text-blue-600 hover:underline text-sm">&larr; Back to campaigns</a>
</div>

<h1 class="text-2xl font-bold mb-4">Campaign {{ campaign.id }}: {{ campaign.subject_name }}/{{ campaign.chaos_type }}</h1>

<div class="bg-white shadow rounded p-4 mb-4">
    <h2 class="text-lg font-semibold mb-2">Details</h2>
    <dl class="grid grid-cols-2 gap-2 text-sm">
        <dt class="text-gray-500">Subject:</dt>
        <dd>{{ campaign.subject_name }}</dd>
        <dt class="text-gray-500">Chaos Type:</dt>
        <dd>{{ campaign.chaos_type }}</dd>
        <dt class="text-gray-500">Trial Count:</dt>
        <dd>{{ campaign.trial_count }}</dd>
        <dt class="text-gray-500">Baseline:</dt>
        <dd>{% if campaign.baseline %}Yes{% else %}No{% endif %}</dd>
        <dt class="text-gray-500">Created:</dt>
        <dd>{{ campaign.created_at }}</dd>
    </dl>
</div>

<h2 class="text-xl font-bold mb-4">Trials</h2>

{% if trials %}
<div class="bg-white shadow rounded overflow-hidden">
    <table class="min-w-full">
        <thead class="bg-gray-50">
            <tr>
                <th class="px-4 py-2 text-left text-sm font-medium text-gray-500">ID</th>
                <th class="px-4 py-2 text-left text-sm font-medium text-gray-500">Started</th>
                <th class="px-4 py-2 text-left text-sm font-medium text-gray-500">Chaos Injected</th>
                <th class="px-4 py-2 text-left text-sm font-medium text-gray-500">Resolved</th>
                <th class="px-4 py-2 text-left text-sm font-medium text-gray-500">Ended</th>
            </tr>
        </thead>
        <tbody class="divide-y divide-gray-200">
            {% for trial in trials %}
            <tr class="hover:bg-gray-50">
                <td class="px-4 py-2">
                    <a href="/trial/{{ trial.id }}" class="text-blue-600 hover:underline">{{ trial.id }}</a>
                </td>
                <td class="px-4 py-2 text-sm">{{ trial.started_at[:19] if trial.started_at else "N/A" }}</td>
                <td class="px-4 py-2 text-sm">{{ trial.chaos_injected_at[:19] if trial.chaos_injected_at else "N/A" }}</td>
                <td class="px-4 py-2 text-sm">
                    {% if trial.resolved_at %}
                    <span class="text-green-600">{{ trial.resolved_at[:19] }}</span>
                    {% else %}
                    <span class="text-red-600">Not resolved</span>
                    {% endif %}
                </td>
                <td class="px-4 py-2 text-sm">{{ trial.ended_at[:19] if trial.ended_at else "N/A" }}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>
{% else %}
<div class="bg-white shadow rounded p-4 text-gray-500">
    No trials recorded for this campaign.
</div>
{% endif %}
{% endblock %}
```

5. Create eval/src/eval/viewer/templates/trial.html:
```html
{% extends "base.html" %}

{% block title %}Trial {{ trial.id }} - Eval Viewer{% endblock %}

{% block content %}
<div class="mb-4">
    <a href="/campaign/{{ trial.campaign_id }}" class="text-blue-600 hover:underline text-sm">&larr; Back to campaign</a>
</div>

<h1 class="text-2xl font-bold mb-4">Trial {{ trial.id }}</h1>

<div class="bg-white shadow rounded p-4 mb-4">
    <h2 class="text-lg font-semibold mb-2">Timing</h2>
    <dl class="grid grid-cols-2 gap-2 text-sm">
        <dt class="text-gray-500">Started:</dt>
        <dd>{{ trial.started_at }}</dd>
        <dt class="text-gray-500">Chaos Injected:</dt>
        <dd>{{ trial.chaos_injected_at }}</dd>
        <dt class="text-gray-500">Ticket Created:</dt>
        <dd>{{ trial.ticket_created_at if trial.ticket_created_at else "N/A" }}</dd>
        <dt class="text-gray-500">Resolved:</dt>
        <dd>
            {% if trial.resolved_at %}
            <span class="text-green-600">{{ trial.resolved_at }}</span>
            {% else %}
            <span class="text-red-600">Not resolved</span>
            {% endif %}
        </dd>
        <dt class="text-gray-500">Ended:</dt>
        <dd>{{ trial.ended_at }}</dd>
    </dl>
</div>

<div class="bg-white shadow rounded p-4 mb-4">
    <h2 class="text-lg font-semibold mb-2">Commands ({{ commands|length }})</h2>
    {% if commands %}
    <div class="space-y-2">
        {% for cmd in commands %}
        <div class="bg-gray-50 p-2 rounded font-mono text-sm overflow-x-auto">
            {% if cmd is string %}
            {{ cmd }}
            {% else %}
            {{ cmd.command if cmd.command else cmd }}
            {% endif %}
        </div>
        {% endfor %}
    </div>
    {% else %}
    <p class="text-gray-500">No commands recorded.</p>
    {% endif %}
</div>

{% if reasoning_entries %}
<div class="bg-white shadow rounded p-4 mb-4">
    <h2 class="text-lg font-semibold mb-4">Agent Reasoning Timeline</h2>
    <div class="space-y-2">
        {% for entry in reasoning_entries %}
        <div class="{% if entry.entry_type == 'reasoning' %}bg-blue-50 border-l-4 border-blue-400{% elif entry.entry_type == 'tool_call' %}bg-yellow-50 border-l-4 border-yellow-400{% else %}bg-green-50 border-l-4 border-green-400{% endif %} p-3 rounded-r">
            <div class="flex justify-between items-start mb-1">
                <span class="text-xs font-medium uppercase tracking-wide {% if entry.entry_type == 'reasoning' %}text-blue-600{% elif entry.entry_type == 'tool_call' %}text-yellow-600{% else %}text-green-600{% endif %}">
                    {{ entry.entry_type }}
                </span>
                <span class="text-xs text-gray-500">{{ entry.timestamp }}</span>
            </div>
            {% if entry.tool_name %}
            <div class="font-mono text-sm text-gray-700 mb-1">{{ entry.tool_name }}</div>
            {% endif %}
            <div class="text-sm text-gray-800 whitespace-pre-wrap">{{ entry.content }}</div>
        </div>
        {% endfor %}
    </div>
</div>
{% endif %}
{% endblock %}
```

Use Tailwind classes throughout: bg-white, shadow, rounded, p-4, mb-4, text-gray-*, grid, table layout.
  </action>
  <verify>
Run `python -c "from eval.viewer.routes import router; print('OK')"`
  </verify>
  <done>Routes serve HTML pages for campaign list, campaign detail, trial detail with proper table structure and Jinja2 loops.</done>
</task>

<task type="auto">
  <name>Task 3: Add reasoning timeline from operator.db and viewer CLI command</name>
  <files>eval/src/eval/viewer/routes.py, eval/src/eval/cli.py</files>
  <action>
1. Update get_trial route in routes.py to fetch reasoning entries:

```python
@router.get("/trial/{trial_id}", response_class=HTMLResponse)
async def get_trial(request: Request, trial_id: int):
    """Show trial detail with reasoning timeline."""
    import asyncio
    import json

    db = EvalDB(request.app.state.db_path)
    await db.ensure_schema()

    trial = await db.get_trial(trial_id)
    if trial is None:
        return HTMLResponse(content="Trial not found", status_code=404)

    # Parse commands from JSON
    commands = json.loads(trial.commands_json) if trial.commands_json else []

    # Fetch reasoning entries if operator.db path is available
    reasoning_entries = []
    operator_db_path = request.app.state.operator_db_path

    if operator_db_path and operator_db_path.exists():
        from operator_core.db.audit_log import AuditLogDB

        def get_entries():
            """Sync function to query audit log."""
            audit_db = AuditLogDB(operator_db_path)
            # Find session overlapping with trial timeframe
            # Query all sessions and filter by time overlap
            # Trial window: started_at <= chaos_injected_at, ended_at >= resolved_at
            # For now, get entries within trial time window
            from datetime import datetime

            start_time = datetime.fromisoformat(trial.started_at.replace("Z", "+00:00"))
            end_time = datetime.fromisoformat(trial.ended_at.replace("Z", "+00:00"))

            # Get all log entries and filter by timestamp
            # Note: This is a simplified approach - production would query by session_id
            entries = audit_db.get_entries_by_timerange(start_time, end_time)
            return [
                {
                    "entry_type": e.entry_type,
                    "content": e.content[:500] if len(e.content) > 500 else e.content,
                    "tool_name": e.tool_name,
                    "timestamp": e.timestamp.isoformat() if e.timestamp else None,
                }
                for e in entries
            ]

        try:
            reasoning_entries = await asyncio.to_thread(get_entries)
        except Exception:
            # Silently skip if audit log query fails
            pass

    return request.app.state.templates.TemplateResponse(
        "trial.html",
        {
            "request": request,
            "trial": trial,
            "commands": commands,
            "reasoning_entries": reasoning_entries,
        },
    )
```

Note: The AuditLogDB.get_entries_by_timerange method may need to be added or adapted based on actual API. Use asyncio.to_thread() for sync database queries in async context.

2. Add `viewer` CLI command to eval/src/eval/cli.py:

```python
@app.command()
def viewer(
    db_path: Path = typer.Option(Path("eval.db"), "--db", help="Path to eval database"),
    operator_db: Optional[Path] = typer.Option(None, "--operator-db", help="Path to operator.db for reasoning"),
    host: str = typer.Option("127.0.0.1", "--host", help="Host to bind"),
    port: int = typer.Option(8000, "--port", "-p", help="Port to bind"),
) -> None:
    """Start the web viewer for browsing campaigns and trials."""
    import uvicorn
    from eval.viewer import create_app

    # Auto-detect operator.db if not specified
    if operator_db is None:
        default = Path("data/operator.db")
        if default.exists():
            operator_db = default
            console.print(f"[dim]Using operator.db: {operator_db}[/dim]")

    if not db_path.exists():
        console.print(f"[yellow]Warning: Database {db_path} does not exist. Will be created on first access.[/yellow]")

    app = create_app(db_path, operator_db)
    console.print(f"Starting viewer at http://{host}:{port}")
    uvicorn.run(app, host=host, port=port)
```

Place this command after the existing commands (analyze, compare, compare-baseline).
  </action>
  <verify>
Run:
```bash
cd eval && uv run eval viewer --help
```
Then briefly test server start:
```bash
timeout 3 uv run eval viewer --port 8765 2>&1 | head -5 || true
```
  </verify>
  <done>Viewer CLI starts web server; trial pages show reasoning timeline when operator.db is available.</done>
</task>

</tasks>

<verification>
1. `cd eval && uv sync` - Dependencies install successfully
2. `cd eval && uv run eval viewer --help` - Shows viewer command options
3. Start viewer: `cd eval && uv run eval viewer &`
4. Browse http://localhost:8000 - Shows campaign list (empty or populated)
5. If campaigns exist, click through to campaign detail and trial detail
6. Trial detail shows reasoning timeline if operator.db exists
7. Stop server with Ctrl+C
</verification>

<success_criteria>
- VIEW-04 satisfied: Minimal FastAPI + Jinja2 web viewer browsable via CLI command
- VIEW-05 satisfied: Trial detail shows reasoning and commands from agent session
- Tailwind CSS styling provides modern look
- Static views (refresh to see updates, no WebSocket)
- Pagination present for long lists
</success_criteria>

<output>
After completion, create `.planning/phases/37-viewer-layer/37-02-SUMMARY.md`
</output>
