---
phase: 37-viewer-layer
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - eval/pyproject.toml
  - eval/src/eval/viewer/__init__.py
  - eval/src/eval/viewer/app.py
  - eval/src/eval/viewer/routes.py
  - eval/src/eval/viewer/templates/base.html
  - eval/src/eval/viewer/templates/campaigns.html
  - eval/src/eval/viewer/templates/campaign.html
  - eval/src/eval/viewer/templates/trial.html
  - eval/src/eval/cli.py
autonomous: true

must_haves:
  truths:
    - "Developer can run `eval viewer` and a web server starts"
    - "Developer can browse to / and see campaign list"
    - "Developer can click a campaign and see its details with trial list"
    - "Developer can click a trial and see full detail with reasoning timeline"
    - "Reasoning timeline shows agent thoughts and commands chronologically"
  artifacts:
    - path: "eval/src/eval/viewer/app.py"
      provides: "FastAPI application setup"
      contains: "FastAPI"
    - path: "eval/src/eval/viewer/routes.py"
      provides: "Route handlers for campaigns, trials"
      contains: "async def get_campaign"
    - path: "eval/src/eval/viewer/templates/trial.html"
      provides: "Trial detail with reasoning timeline"
      contains: "reasoning"
    - path: "eval/src/eval/cli.py"
      provides: "viewer command to start server"
      contains: "def viewer"
  key_links:
    - from: "eval/src/eval/viewer/routes.py"
      to: "eval/src/eval/runner/db.py"
      via: "Database queries for campaigns and trials"
      pattern: "EvalDB"
    - from: "eval/src/eval/viewer/routes.py"
      to: "packages/operator-core/src/operator_core/db/audit_log.py"
      via: "Reasoning entries from agent sessions"
      pattern: "agent_log_entries|AuditLogDB"
---

<objective>
Build web viewer for browsing evaluation campaigns and trials with reasoning display.

Purpose: Provides a visual interface for exploring evaluation results, including agent reasoning timeline that shows how the agent diagnosed and resolved issues.

Output: FastAPI web application with Jinja2 templates, Tailwind CSS styling, and chronological reasoning display.
</objective>

<execution_context>
@/Users/jrtipton/.claude/get-shit-done/workflows/execute-plan.md
@/Users/jrtipton/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/37-viewer-layer/37-CONTEXT.md
@.planning/phases/37-viewer-layer/37-RESEARCH.md

# Existing code
@eval/src/eval/cli.py
@eval/src/eval/runner/db.py
@eval/src/eval/types.py
@eval/src/eval/analysis/types.py
@packages/operator-core/src/operator_core/db/schema.py
@packages/operator-core/src/operator_core/db/audit_log.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add FastAPI dependencies and create viewer package structure</name>
  <files>eval/pyproject.toml, eval/src/eval/viewer/__init__.py, eval/src/eval/viewer/app.py</files>
  <action>
1. Add dependencies to eval/pyproject.toml:
   - fastapi>=0.115.0
   - jinja2>=3.1.0
   - uvicorn>=0.32.0

2. Create eval/src/eval/viewer/__init__.py:
   - Empty or with `from .app import create_app`

3. Create eval/src/eval/viewer/app.py:
```python
from fastapi import FastAPI
from fastapi.templating import Jinja2Templates
from pathlib import Path

def create_app(db_path: Path, operator_db_path: Path | None = None) -> FastAPI:
    app = FastAPI(title="Eval Viewer")

    templates_dir = Path(__file__).parent / "templates"
    templates = Jinja2Templates(directory=str(templates_dir))

    # Store paths in app state
    app.state.db_path = db_path
    app.state.operator_db_path = operator_db_path
    app.state.templates = templates

    # Import and include routes
    from .routes import router
    app.include_router(router)

    return app
```

4. Create templates directory: eval/src/eval/viewer/templates/
  </action>
  <verify>
Run `cd eval && uv sync` to install dependencies, then:
`python -c "from eval.viewer.app import create_app; print('OK')"`
  </verify>
  <done>FastAPI app factory created with Jinja2 templates setup.</done>
</task>

<task type="auto">
  <name>Task 2: Create routes and templates for campaigns and trials</name>
  <files>eval/src/eval/viewer/routes.py, eval/src/eval/viewer/templates/base.html, eval/src/eval/viewer/templates/campaigns.html, eval/src/eval/viewer/templates/campaign.html, eval/src/eval/viewer/templates/trial.html</files>
  <action>
1. Create eval/src/eval/viewer/routes.py with three routes:

```python
from fastapi import APIRouter, Request
from fastapi.responses import HTMLResponse

router = APIRouter()

@router.get("/", response_class=HTMLResponse)
async def list_campaigns(request: Request):
    # Get campaigns from db, render campaigns.html

@router.get("/campaign/{campaign_id}", response_class=HTMLResponse)
async def get_campaign(request: Request, campaign_id: int):
    # Get campaign + trials, render campaign.html

@router.get("/trial/{trial_id}", response_class=HTMLResponse)
async def get_trial(request: Request, trial_id: int):
    # Get trial + reasoning entries, render trial.html
```

2. Create base.html with Tailwind CDN:
```html
<!DOCTYPE html>
<html>
<head>
    <title>{% block title %}Eval Viewer{% endblock %}</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 min-h-screen">
    <nav class="bg-white shadow mb-4 px-4 py-2">
        <a href="/" class="text-lg font-bold">Eval Viewer</a>
    </nav>
    <main class="container mx-auto px-4">
        {% block content %}{% endblock %}
    </main>
</body>
</html>
```

3. Create campaigns.html - table of campaigns with links to details

4. Create campaign.html - campaign info + trial list table

5. Create trial.html - trial detail with:
   - Timing info (started, chaos injected, resolved, ended)
   - Outcome and scores
   - Commands list (code blocks)
   - Reasoning timeline section (populated in Task 3)

Use Tailwind classes: bg-white, shadow, rounded, p-4, mb-4, text-gray-*, etc.
Pagination: Show offset/limit controls, link to next/prev pages via query params.
  </action>
  <verify>
Run `python -c "from eval.viewer.routes import router; print('OK')"`
  </verify>
  <done>Routes serve HTML pages for campaign list, campaign detail, trial detail.</done>
</task>

<task type="auto">
  <name>Task 3: Add reasoning timeline from operator.db and viewer CLI command</name>
  <files>eval/src/eval/viewer/routes.py, eval/src/eval/viewer/templates/trial.html, eval/src/eval/cli.py</files>
  <action>
1. Update trial route in routes.py to fetch reasoning:
   - Get operator_db_path from app.state
   - If operator_db_path exists, query agent_log_entries for session
   - Session lookup: Find session by time overlap with trial (started_at <= chaos_injected_at, ended_at >= resolved_at or is NULL)
   - Alternative: Extract session_id from trial if stored (check commands_json for session info)
   - Use asyncio.to_thread() for sync AuditLogDB queries
   - Pass entries to template: list of {entry_type, content, tool_name, timestamp}

2. Update trial.html reasoning section:
```html
{% if reasoning_entries %}
<h2 class="text-xl font-bold mt-6 mb-4">Agent Reasoning Timeline</h2>
<div class="space-y-2">
    {% for entry in reasoning_entries %}
    <div class="{% if entry.entry_type == 'reasoning' %}bg-blue-50{% elif entry.entry_type == 'tool_call' %}bg-yellow-50{% else %}bg-green-50{% endif %} p-3 rounded">
        <div class="text-xs text-gray-500">{{ entry.timestamp }} - {{ entry.entry_type }}</div>
        {% if entry.tool_name %}<div class="font-mono text-sm">{{ entry.tool_name }}</div>{% endif %}
        <div class="mt-1">{{ entry.content }}</div>
    </div>
    {% endfor %}
</div>
{% endif %}
```

3. Add `viewer` CLI command to cli.py:
```python
@app.command()
def viewer(
    db_path: Path = typer.Option(Path("eval.db"), "--db", help="Path to eval database"),
    operator_db: Path | None = typer.Option(None, "--operator-db", help="Path to operator.db for reasoning"),
    host: str = typer.Option("127.0.0.1", "--host", help="Host to bind"),
    port: int = typer.Option(8000, "--port", "-p", help="Port to bind"),
) -> None:
    """Start the web viewer for browsing campaigns and trials."""
    import uvicorn
    from eval.viewer import create_app

    # Auto-detect operator.db
    if operator_db is None:
        default = Path("data/operator.db")
        if default.exists():
            operator_db = default
            console.print(f"[dim]Using operator.db: {operator_db}[/dim]")

    app = create_app(db_path, operator_db)
    console.print(f"Starting viewer at http://{host}:{port}")
    uvicorn.run(app, host=host, port=port)
```

Show command output only on errors in reasoning timeline (success outputs hidden per CONTEXT.md).
  </action>
  <verify>
Run `cd eval && uv run eval viewer --help` to verify command exists.
Start server briefly with timeout: `timeout 3 uv run eval viewer || true`
  </verify>
  <done>Viewer CLI starts web server; trial pages show reasoning timeline.</done>
</task>

</tasks>

<verification>
1. `cd eval && uv sync` - Dependencies install successfully
2. `cd eval && uv run eval viewer --help` - Shows viewer command options
3. Start viewer: `cd eval && uv run eval viewer &`
4. Browse http://localhost:8000 - Shows campaign list (empty or populated)
5. If campaigns exist, click through to campaign detail and trial detail
6. Trial detail shows reasoning timeline if operator.db exists
7. Stop server with Ctrl+C
</verification>

<success_criteria>
- VIEW-04 satisfied: Minimal FastAPI + Jinja2 web viewer browsable via CLI command
- VIEW-05 satisfied: Trial detail shows reasoning and commands from agent session
- Tailwind CSS styling provides modern look
- Static views (refresh to see updates, no WebSocket)
- Pagination present for long lists
</success_criteria>

<output>
After completion, create `.planning/phases/37-viewer-layer/37-02-SUMMARY.md`
</output>
